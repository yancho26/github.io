<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–º–µ—Ç–æ –Ω–∞ –ß—É–¥–æ—Ç–æ - –ï–∫—Å–ø–µ—Ä—Ç–µ–Ω –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes progressAnim {
            0% { width: 0%; }
            50% { width: 60%; }
            80% { width: 85%; }
            100% { width: 100%; }
        }
        .animate-progress-bar {
            animation: progressAnim 2.5s ease-in-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        .step-container { display: none; }
        .step-container.active { display: block; }
        
        /* –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω —Å–∫—Ä–æ–ª–±–∞—Ä –∑–∞ —Å–ø–∏—Å—ä–∫–∞ —Å –ª—é–±–∏–º–∏ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 font-sans text-gray-800 min-h-screen relative">

    <!-- –•–µ–¥—ä—Ä -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-10">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2 text-indigo-600">
                <i data-lucide="baby" class="w-8 h-8"></i>
                <h1 class="text-2xl font-bold tracking-tight hidden sm:block">–ò–º–µ—Ç–æ –Ω–∞ –ß—É–¥–æ—Ç–æ</h1>
                <h1 class="text-xl font-bold tracking-tight sm:hidden">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h1>
            </div>
            <div class="flex items-center gap-3 sm:gap-4">
                <div class="hidden md:flex text-sm font-medium text-gray-500 items-center gap-1 bg-gray-100 px-3 py-1.5 rounded-full">
                    <i data-lucide="database" class="w-4 h-4"></i>
                    <span id="db-count-badge">–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ –±–∞–∑–∞—Ç–∞...</span>
                </div>
                <button onclick="openFavorites()" class="relative flex items-center gap-1 bg-pink-100 hover:bg-pink-200 text-pink-700 px-4 py-2 rounded-full transition-colors font-medium shadow-sm">
                    <i data-lucide="heart" class="w-4 h-4" id="header-heart-icon"></i>
                    <span class="hidden sm:inline">–õ—é–±–∏–º–∏</span>
                    <span id="fav-count-badge" class="hidden absolute -top-1 -right-1 bg-pink-500 text-white text-[11px] font-bold w-5 h-5 rounded-full flex items-center justify-center border-2 border-white shadow-sm">0</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8 sm:py-12">
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä -->
        <div id="progress-section" class="mb-8">
            <div class="flex justify-between text-xs font-medium text-gray-400 mb-2 px-1">
                <span id="prog-text-1" class="text-indigo-600">–û—Å–Ω–æ–≤–∏</span>
                <span id="prog-text-2">–ü—Ä–æ–∏–∑—Ö–æ–¥</span>
                <span id="prog-text-3">–†–æ–¥ –∏ –§–∞–º–∏–ª–∏—è</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-indigo-600 transition-all duration-500 ease-out" style="width: 33.33%;"></div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-white">
            <div class="p-6 sm:p-12 relative">
                
                <!-- –°—Ç—ä–ø–∫–∞ 1: –ü–æ–ª -->
                <div id="step-1" class="step-container active fade-in">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="baby" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">–ö–æ–≥–æ –æ—á–∞–∫–≤–∞—Ç–µ?</h2>
                        <p class="text-gray-500">–ù–µ–∫–∞ –∑–∞–ø–æ—á–Ω–µ–º —Å –Ω–∞–π-–≤–∞–∂–Ω–æ—Ç–æ.</p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                        <button onclick="selectGender('m')" id="btn-gender-m" class="p-4 rounded-2xl border-2 transition-all border-gray-100 hover:border-blue-200 hover:bg-blue-50/50">
                            <div class="text-xl font-semibold mb-1">–ú–æ–º—á–µ üë¶üèª</div>
                        </button>
                        <button onclick="selectGender('f')" id="btn-gender-f" class="p-4 rounded-2xl border-2 transition-all border-gray-100 hover:border-pink-200 hover:bg-pink-50/50">
                            <div class="text-xl font-semibold mb-1">–ú–æ–º–∏—á–µ üëßüèª</div>
                        </button>
                        <button onclick="selectGender('any')" id="btn-gender-any" class="p-4 rounded-2xl border-2 transition-all border-purple-500 bg-purple-50 text-purple-700">
                            <div class="text-xl font-semibold mb-1">–ò–∑–Ω–µ–Ω–∞–¥–∞ üéÅ</div>
                        </button>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="goToStep(2)" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-medium transition-colors shadow-md">
                            –ù–∞–ø—Ä–µ–¥ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- –°—Ç—ä–ø–∫–∞ 2: –ö—É–ª—Ç—É—Ä–∞ –∏ –ü—Ä–æ–∏–∑—Ö–æ–¥ -->
                <div id="step-2" class="step-container fade-in">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="globe" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">–ü—Ä–æ–∏–∑—Ö–æ–¥ –Ω–∞ –∏–º–µ—Ç–æ</h2>
                        <p class="text-gray-500">–ò–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∞ –∫—É–ª—Ç—É—Ä–∞ –∑–∞ –∑–≤—É—á–µ–Ω–µ—Ç–æ.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8" id="culture-options">
                        <!-- –î–∏–Ω–∞–º–∏—á–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ –æ–ø—Ü–∏–∏ —á—Ä–µ–∑ JS -->
                    </div>
                    
                    <div class="flex justify-between">
                        <button onclick="goToStep(1)" class="text-gray-500 hover:text-gray-700 px-4 sm:px-6 py-3 font-medium transition-colors">–ù–∞–∑–∞–¥</button>
                        <button onclick="goToStep(3)" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-medium transition-colors shadow-md">
                            –ù–∞–ø—Ä–µ–¥ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- –°—Ç—ä–ø–∫–∞ 3: –†–æ–¥ –∏ –§–∞–º–∏–ª–∏—è -->
                <div id="step-3" class="step-container fade-in">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="users" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">–°–µ–º–µ–π–Ω–∏ –¢—Ä–∞–¥–∏—Ü–∏–∏</h2>
                        <p class="text-gray-500">–£—Å—ä–≤—ä—Ä—à–µ–Ω—Å—Ç–≤–∞–Ω –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Å—Ä–∏—á–∫–∏ –∏ —Ñ–æ–Ω–µ—Ç–∏—á–µ–Ω —Ä–∏—Ç—ä–º.</p>
                    </div>

                    <div class="space-y-6 mb-8 text-left">
                        <!-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="bg-indigo-50/50 p-5 sm:p-6 rounded-2xl border border-indigo-100">
                            <h3 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center gap-2">
                                <i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i> –ó–∞ –ø—ä–ª–Ω–æ—Ç–æ –∏–º–µ
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–§–∞–º–∏–ª–∏—è –Ω–∞ –¥–µ—Ç–µ—Ç–æ</label>
                                    <input type="text" id="inp-lastName" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –ì–µ–æ—Ä–≥–∏–µ–≤ / –ì–µ–æ—Ä–≥–∏–µ–≤–∞"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ò–º–µ –Ω–∞ –±–∞—â–∞—Ç–∞ (–∑–∞ –ü—Ä–µ–∑–∏–º–µ)</label>
                                    <input type="text" id="inp-fatherName" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –Ø–Ω—á–æ"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ò–º–µ –Ω–∞ –º–∞–π–∫–∞—Ç–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)</label>
                                    <input type="text" id="inp-motherName" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –ú–∞—Ä–∏—è"/>
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1 font-semibold text-indigo-700">–ñ–µ–ª–∞–Ω–∞ –ø—ä—Ä–≤–∞ –±—É–∫–≤–∞ (–ò–∑–∫–ª—é—á–∏—Ç–µ–ª–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)</label>
                                    <input type="text" id="inp-preferredLetter" maxlength="1" class="w-full px-4 py-2 border border-indigo-300 bg-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all uppercase shadow-inner" placeholder="–Ω–∞–ø—Ä. –ê"/>
                                </div>
                            </div>
                        </div>

                        <!-- –ë–∞–±–∏ –∏ –¥—è–¥–æ–≤—Ü–∏ -->
                        <div class="bg-gray-50 p-5 sm:p-6 rounded-2xl border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="heart" class="w-5 h-5 text-pink-500"></i> –ò–º–µ–Ω–∞ –Ω–∞ –±–∞–±–∏ –∏ –¥—è–¥–æ–≤—Ü–∏
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" id="inp-gp1" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 1"/>
                                <input type="text" id="inp-gp2" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 2"/>
                                <input type="text" id="inp-gp3" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 3"/>
                                <input type="text" id="inp-gp4" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 4"/>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col-reverse sm:flex-row justify-between items-center gap-4">
                        <button onclick="goToStep(2)" class="w-full sm:w-auto text-gray-500 hover:text-gray-700 px-6 py-3 font-medium transition-colors">–ù–∞–∑–∞–¥</button>
                        <button onclick="generateNamesBtnClick(false)" id="btn-generate" class="w-full sm:w-auto flex justify-center items-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-indigo-200 transition-all transform hover:scale-105">
                            <span>–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ò–º–µ–Ω–∞</span> <i data-lucide="sparkles" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- –ï–∫—Ä–∞–Ω –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ -->
                <div id="loading-screen" class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center rounded-3xl p-6 text-center">
                    <i data-lucide="cpu" class="w-12 h-12 text-indigo-500 animate-bounce mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2 animate-pulse">–ï–∫—Å–ø–µ—Ä—Ç–µ–Ω –ê–Ω–∞–ª–∏–∑...</h3>
                    <p class="text-gray-500 max-w-sm" id="loading-text">–¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ —Ñ–æ–Ω–µ—Ç–∏—á–Ω–∏ —Å—ä–≤–ø–∞–¥–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Å—Ä–∏—á–∫–∏...</p>
                    <div class="w-full max-w-xs h-2 bg-gray-200 rounded-full mt-6 overflow-hidden">
                        <div class="h-full bg-indigo-500 rounded-full animate-progress-bar"></div>
                    </div>
                </div>

                <!-- –°—Ç—ä–ø–∫–∞ 4: –†–µ–∑—É–ª—Ç–∞—Ç–∏ -->
                <div id="step-4" class="step-container fade-in">
                    <div class="text-center mb-10">
                        <div class="inline-block px-4 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-bold mb-4 shadow-sm">
                            <i data-lucide="check-circle" class="w-4 h-4 inline-block mr-1 -mt-0.5"></i> –û—Ç–∫—Ä–∏—Ç–∏ –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–∏ —Å—ä–≤–ø–∞–¥–µ–Ω–∏—è!
                        </div>
                        <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-4">–ï—Ç–æ –Ω–∞—à–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
                        <p class="text-gray-600 max-w-lg mx-auto">
                            –°–æ—Ä—Ç–∏—Ä–∞–Ω–∏ –ø–æ –Ω–∞–π-–≤–∏—Å–æ–∫ —Ä–µ–∑—É–ª—Ç–∞—Ç —Å–ø–æ—Ä–µ–¥ –≤–∞—à–∏—Ç–µ —Å–µ–º–µ–π–Ω–∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –∏ —Ñ–æ–Ω–µ—Ç–∏—á–µ–Ω —Ä–∏—Ç—ä–º.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10" id="results-container">
                        <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç —Ç—É–∫ -->
                    </div>

                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="generateNamesBtnClick(true)" class="flex items-center justify-center gap-2 bg-white border-2 border-indigo-100 hover:border-indigo-300 hover:bg-indigo-50 text-indigo-700 px-6 py-3 rounded-full font-medium transition-colors shadow-sm">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i> –û—â–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
                        </button>
                        <button onclick="resetForm()" class="flex items-center justify-center gap-2 bg-gray-900 hover:bg-gray-800 text-white px-6 py-3 rounded-full font-medium transition-colors shadow-md">
                            –ó–∞–ø–æ—á–Ω–∏ –æ—Ç–Ω–∞—á–∞–ª–æ
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª –∑–∞ –õ—é–±–∏–º–∏ –∏–º–µ–Ω–∞ -->
        <div id="favorites-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6 bg-gray-900/60 backdrop-blur-sm fade-in">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden border border-pink-100">
                <div class="p-6 border-b border-pink-100 flex items-center justify-between bg-gradient-to-r from-pink-50 to-white">
                    <div class="flex items-center gap-3 text-pink-700">
                        <div class="p-2 bg-pink-100 rounded-full">
                            <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                        </div>
                        <h2 class="text-2xl font-bold">–í–∞—à–∏—Ç–µ –õ—é–±–∏–º–∏</h2>
                    </div>
                    <button onclick="closeFavorites()" class="p-2 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-full transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div id="favorites-container" class="p-4 sm:p-6 overflow-y-auto flex-1 bg-gray-50/50">
                    <!-- –õ—é–±–∏–º–∏—Ç–µ –∏–º–µ–Ω–∞ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç —Ç—É–∫ -->
                </div>
            </div>
        </div>

    </main>

    <!-- Vanilla JavaScript –õ–æ–≥–∏–∫–∞ -->
    <script>
        // ==========================================
        // 1. –î–ê–ù–ù–ò –ò –ì–ï–ù–ï–†–ê–¢–û–† –ù–ê –ë–ê–ó–ê (–æ—Ç Python)
        // ==========================================
        
        const BG_ROOTS = [
            { r: "–†–∞–¥", m: "—Ä–∞–¥–æ—Å—Ç" }, { r: "–ú–∏–ª", m: "–º–∏–ª–æ—Å—Ç" }, { r: "–ë–æ–∂", m: "–±–æ–∂–µ—Å—Ç–≤–µ–Ω–æ—Å—Ç" },
            { r: "–°–ª–∞–≤", m: "—Å–ª–∞–≤–∞" }, { r: "–°–≤–µ—Ç", m: "—Å–≤–µ—Ç–ª–∏–Ω–∞" }, { r: "–î–æ–±—Ä", m: "–¥–æ–±—Ä–æ—Ç–∞" },
            { r: "–ö—Ä–∞—Å", m: "–∫—Ä–∞—Å–æ—Ç–∞" }, { r: "–í–ª–∞–¥", m: "–≤–ª–∞—Å—Ç –∏ —Å–∏–ª–∞" }, { r: "–î—Ä–∞–≥", m: "—Å–∫—ä–ø–æ—Ü–µ–Ω–Ω–æ—Å—Ç" },
            { r: "–ó–ª–∞—Ç", m: "–∑–ª–∞—Ç–æ –∏ –±–æ–≥–∞—Ç—Å—Ç–≤–æ" }, { r: "–°—Ç–∞–Ω", m: "—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç" }, { r: "–¶–≤–µ—Ç", m: "—Ü–≤–µ—Ç—è" },
            { r: "–í–µ–Ω", m: "–≤–µ–Ω—Ü–∏ –∏ –ø–æ–±–µ–¥–∞" }, { r: "–í–µ—Å", m: "–≤–µ—Å–µ–ª–∏–µ" }, { r: "–¢–∏—Ö–æ", m: "—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ" },
            { r: "–ñ–∏–≤", m: "–∂–∏–≤–æ—Ç" }, { r: "–ó–¥—Ä–∞–≤", m: "–∑–¥—Ä–∞–≤–µ" }, { r: "–ò—Å–∫—Ä", m: "–∏—Å–∫—Ä–∞" },
            { r: "–ü–ª–∞–º", m: "–ø–ª–∞–º—ä–∫" }, { r: "–†—É–º", m: "—Ä—É–º–µ–Ω–∏–Ω–∞" }, { r: "–°–ø–∞—Å", m: "—Å–ø–∞—Å–µ–Ω–∏–µ" },
            { r: "–°—Ç–æ–π", m: "–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ" }, { r: "–ë–ª–∞–≥–æ", m: "–±–ª–∞–≥–æ—Å—Ç" }, { r: "–ë–æ–≥–æ", m: "–±–æ–∂–∏—è –±–ª–∞–≥–æ–¥–∞—Ç" },
            { r: "–ë—Ä–∞–Ω–∏", m: "–∑–∞—â–∏—Ç–∞" }, { r: "–í–µ–ª–∏", m: "–≤–µ–ª–∏—á–∏–µ" }, { r: "–ñ–µ–ª", m: "–∂–µ–ª–∞–Ω–∏–µ" },
            { r: "–õ—ä—á", m: "—Å–≤–µ—Ç–ª–∏–Ω–∞" }, { r: "–û–≥–Ω", m: "–æ–≥—ä–Ω" }, { r: "–ü—Ä–∞–≤", m: "—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç" },
            { r: "–Ø—Å–Ω", m: "—è—Å–Ω–æ—Ç–∞" }, { r: "–õ—é–±", m: "–ª—é–±–æ–≤" }, { r: "–ú–∏—Ä", m: "–º–∏—Ä –∏ —Ö–∞—Ä–º–æ–Ω–∏—è" },
            { r: "–î–µ—Å–∏", m: "–Ω–∞–¥–µ–∂–¥–∞" }, { r: "–ë–æ—è–Ω", m: "–±–æ–≥–∞—Ç—Å—Ç–≤–æ" }, { r: "–ö–∞–º–µ–Ω", m: "—Ç–≤—ä—Ä–¥–æ—Å—Ç" },
            { r: "–†–æ—Å–µ–Ω", m: "—Ä–æ—Å–∞" }, { r: "–Ø–≤–æ—Ä", m: "—Å–∏–ª–∞" }, { r: "–ï–ª–µ–Ω", m: "–≥—Ä–∞—Ü–∏—è" },
            { r: "–ë–∏—Å—Ç", m: "–±–∏—Å—Ç—Ä–æ—Ç–∞" }, { r: "–°—Ä–µ–±—Ä", m: "—Å—Ä–µ–±—Ä–æ" }, { r: "–¢—Ä–∞–π", m: "–¥—ä–ª–≥–æ–ª–µ—Ç–∏–µ" },
            { r: "–ö—Ä—ä—Å—Ç", m: "–≤—è—Ä–∞" }, { r: "–ú–∞–ª–∏–Ω", m: "—Å–ª–∞–¥–æ—Å—Ç" }, { r: "–í—ä–ª", m: "—Å–∏–ª–∞ –Ω–∞ –≤—ä–ª–∫" },
            { r: "–°–æ–∫–æ–ª", m: "–≤–æ–ª–Ω–æ—Å—Ç" }, { r: "–û—Ä–ª–∏–Ω", m: "–º–æ—â" }, { r: "–ì–æ—Ä–∞–Ω", m: "–≥–æ—Ä–∞/–ø—Ä–∏—Ä–æ–¥–∞" },
            { r: "–î–∞–º—è–Ω", m: "–ø–æ–±–µ–¥–∏—Ç–µ–ª" }, { r: "–ù–∞–π", m: "–ø—ä—Ä–≤–µ–Ω—Å—Ç–≤–æ" }
        ];

        const BG_SUF_M = ['–æ–º–∏—Ä', '–æ—Å–ª–∞–≤', '–∞–Ω', '–∏–Ω', '–µ–Ω', '–µ–º–∏—Ä', '–∫–æ', '—á–æ', '–∏–ª', '–∏–º', '—å–æ', '—é', '–¥–∞–Ω', '–¥–∞—Ä', '–ª—é–±', '–∑–∞—Ä', '–º–∏—Ä', '—Å–ª–∞–≤', '–∞–¥–∏–Ω', '–∏—è–Ω', '–µ–ª–∏–Ω', '–µ–Ω–∏–π', '–∞—Ä–∏–π', '–∏–º–∏—Ä', '–∞—Å–ª–∞–≤', '–æ–¥–∞—Ä', '–æ–ª—é–±', '–æ–∑–∞—Ä', '–∏—Å–ª–∞–≤', '–µ—Ü', '–æ–π', '—É—à', '–µ–Ω–∫–æ', '–∞–Ω–∫–æ', '–∏–ª–∏–Ω', '–æ–≤–µ—Å—Ç', '–æ–≤–∏–¥'];
        const BG_SUF_F = ['–æ–º–∏—Ä–∞', '–æ—Å–ª–∞–≤–∞', '–∞–Ω–∞', '–∏–Ω–∞', '–µ–Ω–∞', '–µ–º–∏—Ä–∞', '–∫–∞', '—á–∫–∞', '–∏–ª–∞', '–∏–º–∞', '—è', '—è–Ω–∞', '–¥–∞–Ω–∞', '–¥–∞—Ä–∞', '–ª—é–±–∞', '–∑–∞—Ä–∞', '–º–∏—Ä–∞', '—Å–ª–∞–≤–∞', '–∏—è–Ω–∞', '–µ–ª–∏–Ω–∞', '–µ–Ω–∏—è', '–∞—Ä–∏—è', '–∏–º–∏—Ä–∏', '–∞—Å–ª–∞–≤–∞', '–æ–¥–∞—Ä–∞', '–æ–ª—é–±–∞', '–µ—Ç–∞', '—É—à–∞', '–µ–Ω–∫–∞', '–∞–Ω–∫–∞', '–∏–ª–∏–Ω–∞', '–æ–≤–µ—Å—Ç–∞', '–æ–≤–∏–¥–∞'];

        const WEST_ROOTS = ["–ê–ª", "–ï–ª", "–ö—Ä–∏—Å", "–õ–µ–æ", "–î–∞–Ω", "–°–∞–º", "–û–ª–∏", "–ë–µ–Ω", "–ì–∞–±", "–ù–∏–∫", "–¢–µ–æ", "–ú–∞–∫—Å", "–õ—É–∫", "–ú–∞—Ä", "–§–µ–ª", "–ê–Ω—Ç", "–í–∞–ª", "–†–æ–º", "–°–∏–ª", "–§–ª–æ—Ä", "–Æ–ª", "–ê–≤–≥", "–ï–¥", "–†–∏—á", "–ê—Ä", "–î–∂–µ–π", "–î–∂–æ–Ω", "–†–æ–±", "–£–∏–ª", "–†–∏–∫"];
        const WEST_SUF_M = ['–±—ä—Ä—Ç', '–∫—Å', '—Å', '–Ω', '–∞–º', '–∏', '–∏–∞–Ω', '–µ–ª', '–∞—Å', '–æ', '–∞—Ä–¥', '—ä—Ä', '–∏–π', '–∏–∫', '—ä—Å', '–µ–Ω', '–æ–Ω', '—ä—Ä–¥', '–º–∞–Ω', '–≤–∞–ª–¥', '–º—ä–Ω–¥', '—Å—ä–Ω', '—Ç—ä–Ω', '—Ä–∏–∫', '–≤—ä–Ω'];
        const WEST_SUF_F = ['–∞', '–∏—è', '–º–∞', '–±–µ–ª–∞', '–≤–∏—è', '–Ω–¥–∞', '–ª–∏–Ω', '—Ä–∞', '—Å–∞', '–Ω–∞', '–µ—Ç–∞', '–∏–Ω–∞', '–ª–∏—è', '—Ä–∏—Å–∞', '–±–µ–ª', '–∞–Ω–∞', '–æ—Ä–∞', '–µ–ª–∞', '–Ω–∏–∫–∞', '—Å–∏', '—Å–∏–∫–∞', '–ª–∞–π–Ω', '–ª–µ—Ç'];

        const MED_ROOTS = ["–ú–∞—Ç", "–ê–ª–µ—Å", "–õ–µ–æ–Ω", "–õ–æ—Ä", "–ì–∞–±—Ä", "–†–∏–∫", "–¢–æ–º", "–ï–¥–æ", "–î–∏–µ", "–°–∞–Ω—Ç", "–°–µ–±", "–ê–ª–µ—Ö", "–•—É–∞–Ω", "–ö–∞—Ä–ª", "–ü–µ–¥", "–õ—É–∏—Å", "–ò–≥–Ω", "–ê–Ω–¥—Ä", "–ö–æ—Å—Ç", "–Ø–Ω", "–î–∏–º", "–°–ø–∏—Ä", "–î–∂—É", "–ê—É—Ä", "–ê–ª–∏", "–î–∂–∏–Ω"];
        const MED_SUF_M = ['–µ–æ', '–∞–Ω–¥—Ä–æ', '–∞—Ä–¥–æ', '–µ–Ω—Ü–æ', '–∏–µ–ª–µ', '–∞–∑–æ', '–µ–≥–æ', '—è–≥–æ', '–∞—Å—Ç–∏–∞–Ω', '–∞—Å', '–æ—Å', '–∏—Å', '—Ä–æ—Å', '–π–æ—Ç–∏—Å', '–æ', '–∞—Ä–æ—Å'];
        const MED_SUF_F = ['–ª–∏—è', '–æ—Ä–∞', '—á–µ', '–µ–≤—Ä–∞', '–æ–Ω–æ—Ä–∞', '–¥–∂–∏—è', '—Ç–∏–Ω–∞', '—Ä–∞', '—á–∏—è', '—Å–∏—è', '–º–µ–Ω', '—Å–∞', '–Ω–∫–∞', '–∑–∞', '–ª–∞', '–ª–æ—Ç–∞', '–Ω–∏', '–∞—Å–∏—è', '–∏–Ω–∞', '–∏–∫–∏'];

        const CELTIC_ROOTS = ["–ê—Ä", "–ë—Ä–∞–Ω", "–ö–æ–Ω–∞–Ω", "–î–æ–Ω–∞–ª", "–§–∏–Ω", "–ì–∞—Ä–µ—Ç", "–¢—Ä–∏—Å", "–ò–∑–æ–ª", "–ì–µ–Ω", "–ú–æ—Ä–≥"];
        const CELTIC_SUF = ["—Ç—ä–Ω", "–¥–∞–Ω", "–º–æ—Ä", "–≥–∞–ª", "–≤–∞–Ω", "–¥–∞", "–µ–≤—Ä–∞", "–∞–Ω–∞"];

        const ASIAN_ROOTS = ["–ê–∫–∏", "–•–∏—Ä–æ", "–ö–µ–Ω", "–¢–∞–∫–∞", "–†—é", "–î–∞–π", "–ö–∞–∑—É", "–ú–∞—é", "–Æ–∫–∏", "–°–∞–∫—É"];
        const ASIAN_SUF = ["—Ä–æ", "—à–∏", "–¥–∂–∏", "—Ç–∞", "–∫–∏", "—Ç–æ", "–º–∏", "–Ω–∞", "—Ä–∞", "–∫–æ"];

        const CULTURES = [
            { val: 'any', label: '–í—Å–∏—á–∫–∏ (–ì–ª–æ–±–∞–ª–Ω–æ)' },
            { val: 'bg', label: '–ë—ä–ª–≥–∞—Ä—Å–∫–∏ / –°–ª–∞–≤—è–Ω—Å–∫–∏' },
            { val: 'western', label: '–ó–∞–ø–∞–¥–Ω–∏ (–ê–Ω–≥–ª, –ù–µ–º—Å–∫–∏...)' },
            { val: 'mediterranean', label: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏' },
            { val: 'celtic', label: '–ö–µ–ª—Ç—Å–∫–∏' },
            { val: 'asian', label: '–ê–∑–∏–∞—Ç—Å–∫–∏' }
        ];

        let NAMES_DB = [];

        function generateMassiveDB() {
            let db = [];
            // 1. –°–ª–∞–≤—è–Ω—Å–∫–∏
            BG_ROOTS.forEach(rootObj => {
                BG_SUF_M.forEach(suf => db.push({ name: rootObj.r + suf, gender: 'm', culture: 'bg', meaning: `–ù–æ—Å–µ—â ${rootObj.m} (–°–ª–∞–≤—è–Ω—Å–∫–∏ –∫–æ—Ä–µ–Ω)` }));
                BG_SUF_F.forEach(suf => db.push({ name: rootObj.r + suf, gender: 'f', culture: 'bg', meaning: `–ù–æ—Å–µ—â–∞ ${rootObj.m} (–°–ª–∞–≤—è–Ω—Å–∫–∏ –∫–æ—Ä–µ–Ω)` }));
            });
            // 2. –ó–∞–ø–∞–¥–Ω–∏
            WEST_ROOTS.forEach(root => {
                WEST_SUF_M.forEach(suf => db.push({ name: root + suf, gender: 'm', culture: 'western', meaning: '–ú–æ–¥–µ—Ä–Ω–æ –∑–∞–ø–∞–¥–Ω–æ –∏–º–µ' }));
                WEST_SUF_F.forEach(suf => db.push({ name: root + suf, gender: 'f', culture: 'western', meaning: '–ú–æ–¥–µ—Ä–Ω–æ –∑–∞–ø–∞–¥–Ω–æ –∏–º–µ' }));
            });
            // 3. –°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏
            MED_ROOTS.forEach(root => {
                MED_SUF_M.forEach(suf => db.push({ name: root + suf, gender: 'm', culture: 'mediterranean', meaning: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–æ/–Æ–∂–Ω–æ –∏–º–µ' }));
                MED_SUF_F.forEach(suf => db.push({ name: root + suf, gender: 'f', culture: 'mediterranean', meaning: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–æ/–Æ–∂–Ω–æ –∏–º–µ' }));
            });
            // 4. –ö–µ–ª—Ç—Å–∫–∏
            CELTIC_ROOTS.forEach(root => {
                CELTIC_SUF.forEach(suf => db.push({ name: root + suf, gender: Math.random() < 0.5 ? 'm' : 'f', culture: 'celtic', meaning: '–î—Ä–µ–≤–Ω–æ –∫–µ–ª—Ç—Å–∫–æ –∏–º–µ' }));
            });
            // 5. –ê–∑–∏–∞—Ç—Å–∫–∏
            ASIAN_ROOTS.forEach(root => {
                ASIAN_SUF.forEach(suf => db.push({ name: root + suf, gender: Math.random() < 0.5 ? 'm' : 'f', culture: 'asian', meaning: '–ò–º–µ —Å –∏–∑—Ç–æ—á–µ–Ω –ø—Ä–æ–∏–∑—Ö–æ–¥' }));
            });

            // –°—Ç–∞—Ç–∏—á–Ω–∏ –∏–º–µ–Ω–∞ (–∫–∞–∫—Ç–æ –µ –≤ Python)
            const STATIC_NAMES = [
                ['–ê–ª–µ–∫—Å–∞–Ω–¥—ä—Ä', 'm', 'bg', '–ó–∞—â–∏—Ç–Ω–∏–∫ –Ω–∞ –º—ä–∂–µ—Ç–µ'], ['–ú–∞—Ä–∏—è', 'f', 'bg', '–õ—é–±–∏–º–∞, –∂–µ–ª–∞–Ω–∞'],
                ['–ò–≤–∞–Ω', 'm', 'bg', '–ë–æ–≥ –µ –º–∏–ª–æ—Å—Ç–∏–≤'], ['–ï–ª–µ–Ω–∞', 'f', 'bg', '–°–≤–µ—Ç–ª–∏–Ω–∞'],
                ['–ì–µ–æ—Ä–≥–∏', 'm', 'bg', '–ó–µ–º–µ–¥–µ–ª–µ—Ü'], ['–í–∏–∫—Ç–æ—Ä–∏—è', 'f', 'bg', '–ü–æ–±–µ–¥–∞']
            ];
            STATIC_NAMES.forEach(n => db.push({ name: n[0], gender: n[1], culture: n[2], meaning: n[3] }));

            return db;
        }

        // ==========================================
        // 2. –°–™–°–¢–û–Ø–ù–ò–ï (STATE)
        // ==========================================
        
        let currentState = {
            step: 1,
            formData: {
                gender: 'any',
                culture: 'any',
                motherName: '',
                fatherName: '',
                lastName: '',
                grandparent1: '',
                grandparent2: '',
                grandparent3: '',
                grandparent4: '',
                preferredLetter: ''
            },
            generatedNames: [],
            favorites: [],
            shownNames: new Set()
        };

        // ==========================================
        // 3. –ü–û–ú–û–©–ù–ò –§–£–ù–ö–¶–ò–ò (–ê–õ–ì–û–†–ò–¢–™–ú)
        // ==========================================
        
        function getPatronymic(fatherName, childGender) {
            if (!fatherName) return '';
            const name = fatherName.trim();
            if (name.length < 2) return '';
            
            const lowerName = name.toLowerCase();
            let base = name;
            let suffixM = '–æ–≤';
            let suffixF = '–æ–≤–∞';

            if (lowerName.endsWith('—ä—Ä')) {
                base = name.slice(0, -2) + '—Ä';
            } else if (lowerName.endsWith('—á–æ') || lower_name.endsWith('—å–æ')) {
                base = lowerName.endsWith('—å–æ') ? name.slice(0, -2) : name.slice(0, -1);
                suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
            } else if (lowerName.endsWith('–æ')) {
                base = name.slice(0, -1);
            } else if (lowerName.endsWith('–µ') || lower_name.endsWith('–π') || lower_name.endsWith('—è')) {
                base = name.slice(0, -1);
                suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
            } else if (lowerName.endsWith('–∏')) {
                base = name.slice(0, -1);
                suffixM = '–∏–µ–≤'; suffixF = '–∏–µ–≤–∞';
            } else if (lowerName.endsWith('–∞')) {
                base = name.slice(0, -1);
            }
            
            return childGender === 'm' ? base + suffixM : base + suffixF;
        }

        const isVowel = (char) => /[–∞–µ–∏–æ—É—è—éaeiouy]/i.test(char);

        // ==========================================
        // 4. UI –ò –õ–û–ì–ò–ö–ê –ù–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // ==========================================

        function initApp() {
            NAMES_DB = generateMassiveDB();
            document.getElementById('db-count-badge').textContent = `–ë–∞–∑–∞: ${NAMES_DB.length.toLocaleString('bg-BG')} –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏`;
            
            // –†–µ–Ω–¥–∏—Ä–∞–Ω–µ –Ω–∞ –∫—É–ª—Ç—É—Ä–∏—Ç–µ
            const cultureContainer = document.getElementById('culture-options');
            cultureContainer.innerHTML = CULTURES.map(opt => `
                <label class="flex items-center p-4 rounded-2xl border-2 cursor-pointer transition-all ${currentState.formData.culture === opt.val ? 'border-purple-500 bg-purple-50' : 'border-gray-100 hover:bg-gray-50'}" onclick="selectCulture('${opt.val}')" id="cult-lbl-${opt.val}">
                    <input type="radio" name="culture" value="${opt.val}" ${currentState.formData.culture === opt.val ? 'checked' : ''} class="w-5 h-5 text-purple-600 border-gray-300 focus:ring-purple-500"/>
                    <span class="ml-3 font-medium text-gray-700">${opt.label}</span>
                </label>
            `).join('');

            lucide.createIcons();
        }

        function selectGender(val) {
            currentState.formData.gender = val;
            
            ['m', 'f', 'any'].forEach(g => {
                const btn = document.getElementById(`btn-gender-${g}`);
                btn.className = 'p-4 rounded-2xl border-2 transition-all border-gray-100';
                if(g === 'm') btn.classList.add('hover:border-blue-200', 'hover:bg-blue-50/50');
                if(g === 'f') btn.classList.add('hover:border-pink-200', 'hover:bg-pink-50/50');
                if(g === 'any') btn.classList.add('hover:border-purple-200', 'hover:bg-purple-50/50');
            });

            const activeBtn = document.getElementById(`btn-gender-${val}`);
            if(val === 'm') activeBtn.className = 'p-4 rounded-2xl border-2 transition-all border-blue-500 bg-blue-50 text-blue-700 shadow-sm';
            if(val === 'f') activeBtn.className = 'p-4 rounded-2xl border-2 transition-all border-pink-500 bg-pink-50 text-pink-700 shadow-sm';
            if(val === 'any') activeBtn.className = 'p-4 rounded-2xl border-2 transition-all border-purple-500 bg-purple-50 text-purple-700 shadow-sm';
        }

        function selectCulture(val) {
            currentState.formData.culture = val;
            
            CULTURES.forEach(opt => {
                const lbl = document.getElementById(`cult-lbl-${opt.val}`);
                const radio = lbl.querySelector('input');
                if (opt.val === val) {
                    lbl.className = 'flex items-center p-4 rounded-2xl border-2 cursor-pointer transition-all border-purple-500 bg-purple-50 shadow-sm';
                    radio.checked = true;
                } else {
                    lbl.className = 'flex items-center p-4 rounded-2xl border-2 cursor-pointer transition-all border-gray-100 hover:bg-gray-50';
                    radio.checked = false;
                }
            });
        }

        function goToStep(stepNum) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            
            if (stepNum === 4) {
                document.getElementById('progress-section').style.display = 'none';
            } else {
                document.getElementById('progress-section').style.display = 'block';
                document.getElementById('progress-bar').style.width = `${(stepNum / 3) * 100}%`;
                for(let i=1; i<=3; i++) {
                    const txt = document.getElementById(`prog-text-${i}`);
                    if(stepNum >= i) txt.classList.add('text-indigo-600', 'font-bold');
                    else txt.classList.remove('text-indigo-600', 'font-bold');
                }
            }

            document.getElementById(`step-${stepNum}`).classList.add('active');
            currentState.step = stepNum;
        }

        function readInputs() {
            currentState.formData.lastName = document.getElementById('inp-lastName').value;
            currentState.formData.fatherName = document.getElementById('inp-fatherName').value;
            currentState.formData.motherName = document.getElementById('inp-motherName').value;
            currentState.formData.preferredLetter = document.getElementById('inp-preferredLetter').value;
            currentState.formData.grandparent1 = document.getElementById('inp-gp1').value;
            currentState.formData.grandparent2 = document.getElementById('inp-gp2').value;
            currentState.formData.grandparent3 = document.getElementById('inp-gp3').value;
            currentState.formData.grandparent4 = document.getElementById('inp-gp4').value;
        }

        function generateNamesBtnClick(isRefresh = false) {
            readInputs();
            
            if (!isRefresh) {
                // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞, –∞–∫–æ —Ç–æ–≤–∞ –µ –Ω–æ–≤–æ —Ç—ä—Ä—Å–µ–Ω–µ
                currentState.shownNames.clear();
            }
            
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('loading-screen').classList.remove('hidden');
            
            // –î–∏–Ω–∞–º–∏—á–µ–Ω —Ç–µ–∫—Å—Ç –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ—Ç–æ
            const dbCountStr = NAMES_DB.length.toLocaleString('bg-BG');
            document.getElementById('loading-text').textContent = `–ü—Ä–µ—Ç—ä—Ä—Å–≤–∞–Ω–µ –Ω–∞ ${dbCountStr} –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Å—Ä–∏—á–∫–∏...`;
            
            setTimeout(() => {
                runExpertAlgorithm();
                
                document.getElementById('loading-screen').classList.add('hidden');
                renderResults();
                goToStep(4);
            }, 2500); // –°–∏–º—É–ª–∏—Ä–∞–Ω–æ –≤—Ä–µ–º–µ –∑–∞ "–º–∏—Å–ª–µ–Ω–µ"
        }

        function runExpertAlgorithm() {
            let results = [];
            const prefs = currentState.formData;
            
            const grandparents = [
                prefs.grandparent1.trim(), prefs.grandparent2.trim(),
                prefs.grandparent3.trim(), prefs.grandparent4.trim()
            ].filter(Boolean);

            const parents = [
                prefs.motherName.trim(), prefs.fatherName.trim()
            ].filter(Boolean);

            let pool = NAMES_DB;
            if (prefs.gender !== 'any') {
                pool = pool.filter(n => n.gender === prefs.gender);
            }
            if (prefs.culture !== 'any') {
                pool = pool.filter(n => n.culture === prefs.culture);
            }

            const lastName = prefs.lastName.trim();
            const prefLetter = prefs.preferredLetter.trim().toUpperCase();

            pool.forEach(nameObj => {
                let score = 0;
                let reasons = [];
                const nameStr = nameObj.name;
                const firstLetter = nameStr.charAt(0).toUpperCase();
                
                const patronymic = getPatronymic(prefs.fatherName, nameObj.gender);
                const fullNameArr = [nameStr, patronymic, lastName].filter(Boolean);
                const fullName = fullNameArr.join(' ');
                
                // 1. –ñ–µ–ª–∞–Ω–∞ –±—É–∫–≤–∞ (–û–≥—Ä–æ–º–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
                if (prefLetter && firstLetter === prefLetter.charAt(0)) {
                    score += 150;
                    reasons.push(`–ó–∞–ø–æ—á–≤–∞ —Å –∂–µ–ª–∞–Ω–∞—Ç–∞ –æ—Ç –≤–∞—Å –±—É–∫–≤–∞ '${prefLetter.charAt(0)}'.`);
                }

                // 2. –ï–∫—Å–ø–µ—Ä—Ç–µ–Ω –∞–Ω–∞–ª–∏–∑ –Ω–∞ –±–∞–±–∏ –∏ –¥—è–¥–æ–≤—Ü–∏ (Syllable Matching - Python Logic)
                grandparents.forEach(gp => {
                    const gpClean = gp.toLowerCase();
                    const nameClean = nameStr.toLowerCase();
                    
                    if (nameClean === gpClean) {
                        score += 120;
                        if (!reasons.some(r => r.includes("–ü—ä–ª–Ω–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ"))) reasons.push(`–ü—ä–ª–Ω–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ! –ö—Ä—ä—Å—Ç–µ–Ω–æ —Ç–æ—á–Ω–æ –Ω–∞ ${gp}.`);
                    } else if (gpClean.length >= 3 && nameClean.startsWith(gpClean.substring(0, 3))) {
                        score += 90;
                        if (!reasons.some(r => r.includes("–ø—ä—Ä–≤–∞ —Å—Ä–∏—á–∫–∞"))) reasons.push(`–°–∏–ª–Ω–æ —Ñ–æ–Ω–µ—Ç–∏—á–Ω–æ —Å—ä–≤–ø–∞–¥–µ–Ω–∏–µ (–ø—ä—Ä–≤–∞ —Å—Ä–∏—á–∫–∞) —Å ${gp}.`);
                    } else if (gpClean.length >= 2 && nameClean.startsWith(gpClean.substring(0, 2))) {
                        score += 70;
                        if (!reasons.some(r => r.includes("–Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ –∏–º–µ—Ç–æ"))) reasons.push(`–ó–∞–ø–∞–∑–≤–∞ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ –∏–º–µ—Ç–æ –Ω–∞ ${gp}.`);
                    } else if (firstLetter === gp.charAt(0).toUpperCase()) {
                        score += 50;
                        if (!reasons.some(r => r.includes("–ó–∞–ø–∞–∑–≤–∞ —Ç—Ä–∞–¥–∏—Ü–∏—è—Ç–∞"))) reasons.push(`–ó–∞–ø–∞–∑–≤–∞ —Ç—Ä–∞–¥–∏—Ü–∏—è—Ç–∞ - –∑–∞–ø–æ—á–≤–∞ —Å –±—É–∫–≤–∞—Ç–∞ –Ω–∞ ${gp}.`);
                    }
                });

                // 3. –†–æ–¥–∏—Ç–µ–ª–∏
                parents.forEach(p => {
                    if (p.charAt(0).toUpperCase() === firstLetter) {
                        score += 30;
                        if (!reasons.some(r => r.includes("–ø—ä—Ä–≤–∞—Ç–∞ –±—É–∫–≤–∞ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª"))) reasons.push(`–ù–æ—Å–∏ –ø—ä—Ä–≤–∞—Ç–∞ –±—É–∫–≤–∞ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª (${p}).`);
                    }
                });

                // 4. –§–æ–Ω–µ—Ç–∏—á–µ–Ω —Ä–∏—Ç—ä–º —Å —Ñ–∞–º–∏–ª–∏—è—Ç–∞
                if (lastName) {
                    const firstEndsWithVowel = isVowel(nameStr.slice(-1));
                    const lastStartsWithVowel = isVowel(lastName.charAt(0));
                    
                    if (firstEndsWithVowel !== lastStartsWithVowel) {
                        score += 15;
                        if (!reasons.some(r => r.includes("–ü–ª–∞–≤–µ–Ω —Ñ–æ–Ω–µ—Ç–∏—á–µ–Ω –ø—Ä–µ—Ö–æ–¥"))) reasons.push("–ü–ª–∞–≤–µ–Ω —Ñ–æ–Ω–µ—Ç–∏—á–µ–Ω –ø—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –∏–º–µ –∏ —Ñ–∞–º–∏–ª–∏—è (–≥–ª–∞—Å–Ω–∞-—Å—ä–≥–ª–∞—Å–Ω–∞).");
                    } else {
                        score -= 5;
                    }
                    
                    if (lastName.length > 8 && nameStr.length <= 5) {
                        score += 15;
                        if (!reasons.some(r => r.includes("–ö—Ä–∞—Ç–∫–æ—Ç–æ –∏–º–µ –±–∞–ª–∞–Ω—Å–∏—Ä–∞"))) reasons.push("–ö—Ä–∞—Ç–∫–æ—Ç–æ –∏–º–µ –±–∞–ª–∞–Ω—Å–∏—Ä–∞ –¥—ä–ª–≥–∞—Ç–∞ —Ñ–∞–º–∏–ª–∏—è.");
                    } else if (lastName.length <= 5 && nameStr.length > 6) {
                        score += 15;
                        if (!reasons.some(r => r.includes("–î—ä–ª–≥–æ—Ç–æ –∏–º–µ –ø—Ä–∏–¥–∞–≤–∞ —Ç–µ–∂–µ—Å—Ç"))) reasons.push("–î—ä–ª–≥–æ—Ç–æ –∏–º–µ –ø—Ä–∏–¥–∞–≤–∞ —Ç–µ–∂–µ—Å—Ç –Ω–∞ –∫—Ä–∞—Ç–∫–∞—Ç–∞ —Ñ–∞–º–∏–ª–∏—è.");
                    }
                }

                // –õ–µ–∫ –ø—Ä–æ–∏–∑–≤–æ–ª –∑–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ (0-20 —Ç–æ—á–∫–∏)
                score += Math.floor(Math.random() * 21);

                results.push({ 
                    name: nameStr,
                    fullName: fullName,
                    gender: nameObj.gender,
                    meaning: nameObj.meaning,
                    score: score,
                    reasons: [...new Set(reasons)].slice(0, 3) // –ú–∞–∫—Å–∏–º—É–º 3 —É–Ω–∏–∫–∞–ª–Ω–∏
                });
            });

            // –°–æ—Ä—Ç–∏—Ä–∞–Ω–µ
            results.sort((a, b) => b.score - a.score);
            
            // –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç–∏ –ø–æ –ø—ä—Ä–≤–æ –∏–º–µ –∏ –í–ï–ß–ï –ø–æ–∫–∞–∑–∞–Ω–∏ –∏–º–µ–Ω–∞
            let uniqueResults = [];
            let seenNames = new Set();
            for(let r of results) {
                if(!seenNames.has(r.name) && !currentState.shownNames.has(r.name)) {
                    seenNames.add(r.name);
                    uniqueResults.push(r);
                }
            }
            
            // –ó–∞—â–∏—Ç–∞: –ê–∫–æ —Å–º–µ –∏–∑—á–µ—Ä–ø–∞–ª–∏ –≤—Å–∏—á–∫–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏ –∏–º–µ–Ω–∞, –∏–∑—á–∏—Å—Ç–≤–∞–º–µ –ø–∞–º–µ—Ç—Ç–∞ –∏ –∑–∞–ø–æ—á–≤–∞–º–µ –æ—Ç–Ω–∞—á–∞–ª–æ
            if (uniqueResults.length < 6) {
                currentState.shownNames.clear();
                uniqueResults = [];
                seenNames.clear();
                for(let r of results) {
                    if(!seenNames.has(r.name)) {
                        seenNames.add(r.name);
                        uniqueResults.push(r);
                    }
                }
            }
            
            // –§–∏–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ —Ç–æ–ø 6
            const topResults = uniqueResults.slice(0, 6).map(r => {
                if(r.reasons.length === 0) {
                    r.reasons.push(`–ò–∑–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ –±–ª–∞–≥–æ–∑–≤—É—á–Ω–æ –∏–º–µ.`);
                }
                currentState.shownNames.add(r.name); // –ó–∞–ø–∞–∑–≤–∞–º–µ –≥–æ –∫–∞—Ç–æ –ø–æ–∫–∞–∑–∞–Ω–æ
                return r;
            });

            currentState.generatedNames = topResults;
        }

        function toggleFavorite(fullName) {
            let nameData = currentState.generatedNames.find(n => n.fullName === fullName) 
                        || currentState.favorites.find(n => n.fullName === fullName);
            
            if (!nameData) return;

            const index = currentState.favorites.findIndex(n => n.fullName === fullName);
            if (index > -1) {
                currentState.favorites.splice(index, 1);
            } else {
                currentState.favorites.push(nameData);
            }
            
            updateFavoritesBadge();
            renderResults(); // –û–±–Ω–æ–≤—è–≤–∞ –∏–∫–æ–Ω–∏—Ç–µ —Å—ä—Ä—Ü–∞
            if(!document.getElementById('favorites-modal').classList.contains('hidden')) {
                renderFavoritesList();
            }
        }

        function updateFavoritesBadge() {
            const count = currentState.favorites.length;
            const badge = document.getElementById('fav-count-badge');
            const heartIcon = document.getElementById('header-heart-icon');
            
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
                heartIcon.classList.add('fill-current', 'text-pink-600');
            } else {
                badge.classList.add('hidden');
                heartIcon.classList.remove('fill-current', 'text-pink-600');
            }
        }

        function renderResults() {
            const container = document.getElementById('results-container');
            container.innerHTML = currentState.generatedNames.map((nameData, index) => {
                const isFav = currentState.favorites.some(f => f.fullName === nameData.fullName);
                const colorTheme = nameData.gender === 'm' ? 'blue' : 'pink';
                const bgTheme = nameData.gender === 'm' ? 'border-blue-100 bg-gradient-to-br from-white to-blue-50/50' : 'border-pink-100 bg-gradient-to-br from-white to-pink-50/50';
                
                const heartBg = isFav ? 'bg-pink-100 text-pink-500 shadow-inner' : 'bg-white/70 text-gray-400 hover:bg-white hover:text-pink-400 shadow-sm hover:shadow';
                const heartFill = isFav ? 'fill-current' : 'none';
                const topBadgeColor = nameData.gender === 'm' ? 'bg-blue-400 text-blue-900' : 'bg-yellow-400 text-yellow-900';
                
                let reasonsHtml = nameData.reasons.map(reason => `
                    <li class="text-sm text-gray-700 flex items-start gap-2 leading-tight">
                        <span class="text-${colorTheme}-400 mt-0.5 font-bold">‚Ä¢</span> ${reason}
                    </li>
                `).join('');

                let topChoiceBadge = index === 0 ? `
                    <div class="absolute -top-3 -right-3 ${topBadgeColor} text-xs font-bold px-3 py-1 rounded-full flex items-center shadow-md z-10 border-2 border-white">
                        <i data-lucide="award" class="w-3 h-3 mr-1"></i> –¢–æ–ø –∏–∑–±–æ—Ä
                    </div>
                ` : '';

                return `
                    <div class="relative p-6 sm:p-8 rounded-3xl border-2 shadow-sm transition-all hover:shadow-lg ${bgTheme} group">
                        ${topChoiceBadge}
                        <button onclick="toggleFavorite('${nameData.fullName}')" class="absolute top-4 right-4 p-2.5 rounded-full transition-all z-10 ${heartBg}" title="–õ—é–±–∏–º–∏">
                            <i data-lucide="heart" class="w-5 h-5 ${heartFill}"></i>
                        </button>
                        
                        <div class="mb-5 pb-5 border-b border-gray-200/60 pr-12">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1.5 flex items-center gap-1">
                                <i data-lucide="user" class="w-3 h-3"></i> –ü—ä–ª–Ω–æ –∏–º–µ
                            </p>
                            <h3 class="text-2xl sm:text-3xl font-extrabold text-${colorTheme}-900 leading-tight">${nameData.fullName}</h3>
                        </div>

                        <div class="bg-white/60 p-3 rounded-xl mb-4 border border-white shadow-sm">
                            <p class="text-sm font-medium text-gray-600 flex items-start gap-2">
                                <i data-lucide="info" class="w-4 h-4 text-gray-400 mt-0.5 shrink-0"></i>
                                <span><strong class="text-gray-900 font-semibold">–ó–Ω–∞—á–µ–Ω–∏–µ:</strong> ${nameData.meaning}</span>
                            </p>
                        </div>
                        
                        <div class="space-y-3 pl-1">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1">
                                <i data-lucide="cpu" class="w-3 h-3"></i> –ó–∞—â–æ —Ç–æ–∑–∏ –∏–∑–±–æ—Ä?
                            </p>
                            <ul class="space-y-2.5">${reasonsHtml}</ul>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function renderFavoritesList() {
            const container = document.getElementById('favorites-container');
            if (currentState.favorites.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16 text-gray-400 flex flex-col items-center">
                        <div class="bg-gray-100 p-4 rounded-full mb-4">
                            <i data-lucide="heart" class="w-10 h-10 text-gray-300"></i>
                        </div>
                        <p class="text-lg font-medium text-gray-500">–°–ø–∏—Å—ä–∫—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω.</p>
                        <p class="text-sm mt-1">–ö–ª–∏–∫–Ω–µ—Ç–µ –≤—ä—Ä—Ö—É —Å—ä—Ä—Ü–µ—Ç–æ –Ω–∞ –Ω—è–∫–æ–µ –∏–º–µ, –∑–∞ –¥–∞ –≥–æ –∑–∞–ø–∞–∑–∏—Ç–µ —Ç—É–∫.</p>
                        <button onclick="closeFavorites()" class="mt-6 px-6 py-2 bg-pink-50 text-pink-600 font-bold rounded-full hover:bg-pink-100 transition-colors">
                            –†–∞–∑–±—Ä–∞—Ö
                        </button>
                    </div>
                `;
            } else {
                let listHtml = currentState.favorites.map(fav => {
                    const colorTxt = fav.gender === 'm' ? 'text-blue-800' : 'text-pink-800';
                    const colorIcon = fav.gender === 'm' ? 'text-blue-400' : 'text-pink-400';
                    const iconType = fav.gender === 'm' ? 'üë¶' : 'üëß';
                    
                    return `
                    <div class="p-4 sm:p-5 rounded-2xl border border-gray-200 bg-white shadow-sm relative group hover:shadow-md transition-shadow">
                        <button onclick="toggleFavorite('${fav.fullName}')" class="absolute top-4 right-4 p-2 text-pink-500 bg-pink-50 hover:bg-pink-100 rounded-full transition-colors" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                        <div class="flex items-start gap-3 pr-10">
                            <div class="text-2xl pt-0.5">${iconType}</div>
                            <div>
                                <h4 class="text-lg font-extrabold mb-1 ${colorTxt} leading-tight">${fav.fullName}</h4>
                                <p class="text-xs text-gray-500 font-medium">${fav.meaning}</p>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
                container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${listHtml}</div>`;
            }
            lucide.createIcons();
        }

        function openFavorites() {
            renderFavoritesList();
            document.getElementById('favorites-modal').classList.remove('hidden');
        }

        function closeFavorites() {
            document.getElementById('favorites-modal').classList.add('hidden');
        }

        function resetForm() {
            document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
            selectGender('any');
            selectCulture('any');
            currentState.generatedNames = [];
            currentState.shownNames.clear();
            goToStep(1);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
        window.onload = initApp;

    </script>
</body>
</html>
