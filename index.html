<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–º–µ—Ç–æ –Ω–∞ –ß—É–¥–æ—Ç–æ - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞ –ë–µ–±–µ—à–∫–∏ –ò–º–µ–Ω–∞</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes progressAnim {
            0% { width: 0%; }
            50% { width: 60%; }
            80% { width: 85%; }
            100% { width: 100%; }
        }
        .animate-progress-bar {
            animation: progressAnim 3.5s ease-in-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .step-container { display: none; }
        .step-container.active { display: block; }
        
        /* –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–æ–ª–±–∞—Ä–∞ –∑–∞ –º–æ–¥–∞–ª–∞ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 font-sans text-gray-800 min-h-screen relative">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-10">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2 text-indigo-600">
                <i data-lucide="baby" class="w-8 h-8"></i>
                <h1 class="text-2xl font-bold tracking-tight">–ò–º–µ—Ç–æ –Ω–∞ –ß—É–¥–æ—Ç–æ</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden sm:flex text-sm font-medium text-gray-500 items-center gap-1 bg-gray-100 px-3 py-1.5 rounded-full">
                    <i data-lucide="globe" class="w-4 h-4"></i>
                    <span id="db-count-badge">–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏: ... –∏–º–µ–Ω–∞</span>
                </div>
                <button onclick="openFavorites()" class="relative flex items-center gap-1 bg-pink-100 hover:bg-pink-200 text-pink-700 px-3 py-1.5 rounded-full transition-colors font-medium">
                    <i data-lucide="heart" class="w-4 h-4" id="header-heart-icon"></i>
                    <span class="hidden sm:inline">–õ—é–±–∏–º–∏</span>
                    <span id="fav-count-badge" class="hidden absolute -top-1 -right-1 bg-pink-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center">0</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-12">
        
        <!-- Progress Bar (Visible steps 1-3) -->
        <div id="progress-section" class="mb-8">
            <div class="flex justify-between text-xs font-medium text-gray-400 mb-2 px-1">
                <span id="prog-text-1" class="text-indigo-600">–û—Å–Ω–æ–≤–∏</span>
                <span id="prog-text-2">–ü—Ä–æ–∏–∑—Ö–æ–¥</span>
                <span id="prog-text-3">–†–æ–¥ –∏ –§–∞–º–∏–ª–∏—è</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-indigo-600 transition-all duration-500 ease-out" style="width: 33.33%;"></div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-white">
            <div class="p-8 sm:p-12 relative">
                
                <!-- –°—Ç—ä–ø–∫–∞ 1: –ü–æ–ª -->
                <div id="step-1" class="step-container active fade-in">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="baby" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">–ö–æ–≥–æ –æ—á–∞–∫–≤–∞—Ç–µ?</h2>
                        <p class="text-gray-500">–ù–µ–∫–∞ –∑–∞–ø–æ—á–Ω–µ–º —Å –Ω–∞–π-–≤–∞–∂–Ω–æ—Ç–æ.</p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                        <button onclick="selectGender('m')" id="btn-gender-m" class="p-4 rounded-2xl border-2 transition-all border-gray-100 hover:border-blue-200 hover:bg-blue-50/50">
                            <div class="text-xl font-semibold mb-1">–ú–æ–º—á–µ üë¶üèª</div>
                        </button>
                        <button onclick="selectGender('f')" id="btn-gender-f" class="p-4 rounded-2xl border-2 transition-all border-gray-100 hover:border-pink-200 hover:bg-pink-50/50">
                            <div class="text-xl font-semibold mb-1">–ú–æ–º–∏—á–µ üëßüèª</div>
                        </button>
                        <button onclick="selectGender('any')" id="btn-gender-any" class="p-4 rounded-2xl border-2 transition-all border-purple-500 bg-purple-50 text-purple-700">
                            <div class="text-xl font-semibold mb-1">–ò–∑–Ω–µ–Ω–∞–¥–∞ üéÅ</div>
                        </button>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="goToStep(2)" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-medium transition-colors">
                            –ù–∞–ø—Ä–µ–¥ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- –°—Ç—ä–ø–∫–∞ 2: –ö—É–ª—Ç—É—Ä–∞ –∏ –ü—Ä–æ–∏–∑—Ö–æ–¥ -->
                <div id="step-2" class="step-container fade-in">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="globe" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">–ü—Ä–æ–∏–∑—Ö–æ–¥ –Ω–∞ –∏–º–µ—Ç–æ</h2>
                        <p class="text-gray-500">–†–∞–∑–ø–æ–ª–∞–≥–∞–º–µ —Å –Ω–∞–¥ 25 000 –∏–º–µ–Ω–∞ –æ—Ç —Ä–∞–∑–ª–∏—á–Ω–∏ –∫—Ä–∞–∏—â–∞ –Ω–∞ —Å–≤–µ—Ç–∞.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8" id="culture-options">
                        <!-- Options generated via JS -->
                    </div>
                    
                    <div class="flex justify-between">
                        <button onclick="goToStep(1)" class="text-gray-500 hover:text-gray-700 px-6 py-3 font-medium transition-colors">–ù–∞–∑–∞–¥</button>
                        <button onclick="goToStep(3)" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-medium transition-colors">
                            –ù–∞–ø—Ä–µ–¥ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- –°—Ç—ä–ø–∫–∞ 3: –†–æ–¥ –∏ –§–∞–º–∏–ª–∏—è -->
                <div id="step-3" class="step-container fade-in">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="users" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">–§–∞–º–∏–ª–∏—è –∏ –†–æ–¥</h2>
                        <p class="text-gray-500">–ê–ª–≥–æ—Ä–∏—Ç—ä–º—ä—Ç –Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —â–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–≤–∞ –∏–º–µ—Ç–æ –Ω–∞ –±–∞—â–∞—Ç–∞ –≤ –ø—Ä–∞–≤–∏–ª–Ω–æ –ø—Ä–µ–∑–∏–º–µ —Å–ø–æ—Ä–µ–¥ –±—ä–ª–≥–∞—Ä—Å–∫–∞—Ç–∞ –≥—Ä–∞–º–∞—Ç–∏–∫–∞.</p>
                    </div>

                    <div class="space-y-6 mb-8 text-left">
                        <!-- –§–∞–º–∏–ª–∏—è –∏ –†–æ–¥–∏—Ç–µ–ª–∏ -->
                        <div class="bg-indigo-50/50 p-6 rounded-2xl border border-indigo-100">
                            <h3 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center gap-2">
                                <i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i> –û—Å–Ω–æ–≤–Ω–∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–§–∞–º–∏–ª–∏—è –Ω–∞ –¥–µ—Ç–µ—Ç–æ</label>
                                    <input type="text" id="inp-lastName" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –ì–µ–æ—Ä–≥–∏–µ–≤ / –ì–µ–æ—Ä–≥–∏–µ–≤–∞"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ò–º–µ –Ω–∞ –±–∞—â–∞—Ç–∞ (–∑–∞ –ü—Ä–µ–∑–∏–º–µ)</label>
                                    <input type="text" id="inp-fatherName" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –Ø–Ω—á–æ"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ò–º–µ –Ω–∞ –º–∞–π–∫–∞—Ç–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)</label>
                                    <input type="text" id="inp-motherName" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –ú–∞—Ä–∏—è"/>
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ñ–µ–ª–∞–Ω–∞ –ø—ä—Ä–≤–∞ –±—É–∫–≤–∞ (–ø–æ –∏–∑–±–æ—Ä)</label>
                                    <input type="text" id="inp-preferredLetter" maxlength="1" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all uppercase" placeholder="–Ω–∞–ø—Ä. –ê"/>
                                </div>
                            </div>
                        </div>

                        <!-- –ë–∞–±–∏ –∏ –¥—è–¥–æ–≤—Ü–∏ -->
                        <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="heart" class="w-5 h-5 text-pink-500"></i> –ò–º–µ–Ω–∞ –Ω–∞ –±–∞–±–∏ –∏ –¥—è–¥–æ–≤—Ü–∏
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" id="inp-gp1" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 1"/>
                                <input type="text" id="inp-gp2" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 2"/>
                                <input type="text" id="inp-gp3" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 3"/>
                                <input type="text" id="inp-gp4" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 4"/>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center">
                        <button onclick="goToStep(2)" class="text-gray-500 hover:text-gray-700 px-6 py-3 font-medium transition-colors">–ù–∞–∑–∞–¥</button>
                        <button onclick="generateNamesBtnClick()" id="btn-generate" class="flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-indigo-200 transition-all transform hover:scale-105">
                            <span id="btn-generate-text">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ò–º–µ–Ω–∞</span> <i data-lucide="sparkles" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- –ï–∫—Ä–∞–Ω –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ -->
                <div id="loading-screen" class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center rounded-3xl">
                    <i data-lucide="search" class="w-12 h-12 text-indigo-500 animate-bounce mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2 animate-pulse">–°–∫–∞–Ω–∏—Ä–∞–Ω–µ –Ω–∞ –±–∞–∑–∏—Ç–µ...</h3>
                    <p class="text-gray-500" id="loading-text">–§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –Ω–∞–¥ 25 000 –∏–º–µ–Ω–∞ –æ—Ç —Ü—è–ª —Å–≤—è—Ç</p>
                    <div class="w-48 h-2 bg-gray-200 rounded-full mt-6 overflow-hidden">
                        <div class="h-full bg-indigo-500 rounded-full animate-progress-bar"></div>
                    </div>
                </div>

                <!-- –°—Ç—ä–ø–∫–∞ 4: –†–µ–∑—É–ª—Ç–∞—Ç–∏ -->
                <div id="step-4" class="step-container fade-in">
                    <div class="text-center mb-10">
                        <div class="inline-block px-4 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-bold mb-4">
                            –û—Ç–∫—Ä–∏—Ç–∏ –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–∏ —Å—ä–≤–ø–∞–¥–µ–Ω–∏—è!
                        </div>
                        <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-4">–ï—Ç–æ –Ω–∞—à–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
                        <p class="text-gray-600 max-w-lg mx-auto">
                            –†–∞–∑–≥–ª–µ–¥–∞–π—Ç–µ –Ω–∞–π-–ø–æ–¥—Ö–æ–¥—è—â–∏—Ç–µ –∏–º–µ–Ω–∞, –ø–æ–¥–±—Ä–∞–Ω–∏ –æ—Ç –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—Ç–∞ –Ω–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10" id="results-container">
                        <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç —Ç—É–∫ -->
                    </div>

                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="generateNamesBtnClick()" class="flex items-center justify-center gap-2 bg-white border-2 border-indigo-100 hover:border-indigo-300 text-indigo-700 px-6 py-3 rounded-full font-medium transition-colors">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i> –î—Ä—É–≥–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
                        </button>
                        <button onclick="resetForm()" class="flex items-center justify-center gap-2 bg-gray-900 hover:bg-gray-800 text-white px-6 py-3 rounded-full font-medium transition-colors">
                            –ó–∞–ø–æ—á–Ω–∏ –æ—Ç–Ω–∞—á–∞–ª–æ
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª –∑–∞ –õ—é–±–∏–º–∏ –∏–º–µ–Ω–∞ -->
        <div id="favorites-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden">
                <div class="p-6 border-b flex items-center justify-between bg-pink-50">
                    <div class="flex items-center gap-2 text-pink-700">
                        <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                        <h2 class="text-2xl font-bold">–õ—é–±–∏–º–∏ –∏–º–µ–Ω–∞</h2>
                    </div>
                    <button onclick="closeFavorites()" class="p-2 text-gray-500 hover:bg-white rounded-full transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div id="favorites-container" class="p-6 overflow-y-auto flex-1">
                    <!-- –õ—é–±–∏–º–∏—Ç–µ –∏–º–µ–Ω–∞ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç —Ç—É–∫ -->
                </div>
            </div>
        </div>

    </main>

    <!-- –°–∫—Ä–∏–ø—Ç –∑–∞ –ª–æ–≥–∏–∫–∞—Ç–∞ (Vanilla JS) -->
    <script>
        // ==========================================
        // 1. –î–ê–ù–ù–ò –ò –ì–ï–ù–ï–†–ê–¢–û–† –ù–ê –ë–ê–ó–ê
        // ==========================================
        
        const BG_ROOTS = [
            { r: '–†–∞–¥', m: '—Ä–∞–¥–æ—Å—Ç' }, { r: '–ú–∏–ª', m: '–º–∏–ª–æ—Å—Ç –∏ –¥–æ–±—Ä–æ—Ç–∞' }, { r: '–ë–æ–∂', m: '–±–æ–∂–µ—Å—Ç–≤–µ–Ω–æ—Å—Ç' }, { r: '–°–ª–∞–≤', m: '—Å–ª–∞–≤–∞' },
            { r: '–°–≤–µ—Ç', m: '—Å–≤–µ—Ç–ª–∏–Ω–∞' }, { r: '–î–æ–±—Ä', m: '–¥–æ–±—Ä–æ—Ç–∞' }, { r: '–ö—Ä–∞—Å', m: '–∫—Ä–∞—Å–æ—Ç–∞' }, { r: '–í–ª–∞–¥', m: '–≤–ª–∞—Å—Ç –∏ —Å–∏–ª–∞' },
            { r: '–î—Ä–∞–≥', m: '—Å–∫—ä–ø–æ—Ü–µ–Ω–Ω–æ—Å—Ç' }, { r: '–ó–ª–∞—Ç', m: '–∑–ª–∞—Ç–æ –∏ –±–æ–≥–∞—Ç—Å—Ç–≤–æ' }, { r: '–°—Ç–∞–Ω', m: '—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç' }, { r: '–¶–≤–µ—Ç', m: '—Ü–≤–µ—Ç—è' },
            { r: '–í–µ–Ω', m: '–≤–µ–Ω—Ü–∏ –∏ –ø–æ–±–µ–¥–∞' }, { r: '–í–µ—Å', m: '–≤–µ—Å–µ–ª–∏–µ' }, { r: '–¢–∏—Ö–æ', m: '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ' }, { r: '–ñ–∏–≤', m: '–∂–∏–≤–æ—Ç' },
            { r: '–ó–¥—Ä–∞–≤', m: '–∑–¥—Ä–∞–≤–µ' }, { r: '–ò—Å–∫—Ä', m: '–∏—Å–∫—Ä–∞' }, { r: '–ü–ª–∞–º', m: '–ø–ª–∞–º—ä–∫' }, { r: '–†—É–º', m: '—Ä—É–º–µ–Ω–∏–Ω–∞' },
            { r: '–°–ø–∞—Å', m: '—Å–ø–∞—Å–µ–Ω–∏–µ' }, { r: '–°—Ç–æ–π', m: '–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ' }, { r: '–ë–ª–∞–≥–æ', m: '–±–ª–∞–≥–æ—Å—Ç' }, { r: '–ë–æ–≥–æ', m: '–±–æ–∂–∏—è –±–ª–∞–≥–æ–¥–∞—Ç' },
            { r: '–ë—Ä–∞–Ω–∏', m: '–∑–∞—â–∏—Ç–∞' }, { r: '–í–µ–ª–∏', m: '–≤–µ–ª–∏—á–∏–µ' }, { r: '–ñ–µ–ª', m: '–∂–µ–ª–∞–Ω–∏–µ' }, { r: '–õ—ä—á', m: '—Å–≤–µ—Ç–ª–∏–Ω–∞' },
            { r: '–û–≥–Ω', m: '–æ–≥—ä–Ω' }, { r: '–ü—Ä–∞–≤', m: '—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç' }, { r: '–Ø—Å–Ω', m: '—è—Å–Ω–æ—Ç–∞' }, { r: '–õ—é–±', m: '–ª—é–±–æ–≤' },
            { r: '–ú–∏—Ä', m: '–º–∏—Ä –∏ —Ö–∞—Ä–º–æ–Ω–∏—è' }, { r: '–î–µ—Å–∏', m: '–Ω–∞–¥–µ–∂–¥–∞' }, { r: '–ë–æ—è–Ω', m: '–±–æ–≥–∞—Ç—Å—Ç–≤–æ' }, { r: '–ö–∞–º–µ–Ω', m: '—Ç–≤—ä—Ä–¥–æ—Å—Ç' },
            { r: '–†–æ—Å–µ–Ω', m: '—Ä–æ—Å–∞, —Å–≤–µ–∂–µ—Å—Ç' }, { r: '–Ø–≤–æ—Ä', m: '–¥—ä—Ä–≤–æ —è–≤–æ—Ä (—Å–∏–ª–∞)' }, { r: '–ï–ª–µ–Ω', m: '–≥—Ä–∞—Ü–∏—è' }, { r: '–ë–∏—Å—Ç', m: '–±–∏—Å—Ç—Ä–æ—Ç–∞' },
            { r: '–°—Ä–µ–±—Ä', m: '—Å—Ä–µ–±—Ä–æ' }, { r: '–¢—Ä–∞–π', m: '–¥—ä–ª–≥–æ–ª–µ—Ç–∏–µ' }, { r: '–ö—Ä—ä—Å—Ç', m: '–≤—è—Ä–∞' }, { r: '–ú–∞–ª–∏–Ω', m: '—Å–ª–∞–¥–æ—Å—Ç' }
        ];

        const BG_SUF_M = ['–æ–º–∏—Ä', '–æ—Å–ª–∞–≤', '–∞–Ω', '–∏–Ω', '–µ–Ω', '–µ–º–∏—Ä', '–∫–æ', '—á–æ', '–∏–ª', '–∏–º', '—å–æ', '—é', '–¥–∞–Ω', '–¥–∞—Ä', '–ª—é–±', '–∑–∞—Ä', '–º–∏—Ä', '—Å–ª–∞–≤', '–∞–¥–∏–Ω', '–∏—è–Ω', '–µ–ª–∏–Ω', '–µ–Ω–∏–π', '–∞—Ä–∏–π', '–∏–º–∏—Ä', '–∞—Å–ª–∞–≤', '–æ–¥–∞—Ä', '–æ–ª—é–±', '–æ–∑–∞—Ä', '–∏—Å–ª–∞–≤', '–µ—Ü', '–æ–π', '—É—à', '–µ–Ω–∫–æ', '–∞–Ω–∫–æ'];
        const BG_SUF_F = ['–æ–º–∏—Ä–∞', '–æ—Å–ª–∞–≤–∞', '–∞–Ω–∞', '–∏–Ω–∞', '–µ–Ω–∞', '–µ–º–∏—Ä–∞', '–∫–∞', '—á–∫–∞', '–∏–ª–∞', '–∏–º–∞', '—è', '—è–Ω–∞', '–¥–∞–Ω–∞', '–¥–∞—Ä–∞', '–ª—é–±–∞', '–∑–∞—Ä–∞', '–º–∏—Ä–∞', '—Å–ª–∞–≤–∞', '–∏—è–Ω–∞', '–µ–ª–∏–Ω–∞', '–µ–Ω–∏—è', '–∞—Ä–∏—è', '–∏–º–∏—Ä–∏', '–∞—Å–ª–∞–≤–∞', '–æ–¥–∞—Ä–∞', '–æ–ª—é–±–∞', '–µ—Ç–∞', '—É—à–∞', '–µ–Ω–∫–∞', '–∞–Ω–∫–∞'];

        const WEST_ROOTS_M = ['–ê–ª', '–ï–ª', '–ö—Ä–∏—Å', '–õ–µ–æ', '–î–∞–Ω', '–°–∞–º', '–û–ª–∏', '–ë–µ–Ω', '–ì–∞–±', '–ù–∏–∫', '–¢–µ–æ', '–ú–∞–∫—Å', '–õ—É–∫', '–ú–∞—Ä', '–§–µ–ª', '–ê–Ω—Ç', '–í–∞–ª', '–†–æ–º', '–°–∏–ª', '–§–ª–æ—Ä', '–Æ–ª', '–ê–≤–≥', '–ï–¥', '–†–∏—á', '–ê—Ä', '–î–∂–µ–π', '–î–∂–æ–Ω', '–†–æ–±', '–£–∏–ª', '–†–∏–∫'];
        const WEST_SUF_M = ['–±—ä—Ä—Ç', '–∫—Å', '—Å', '–Ω', '–∞–º', '–∏', '–∏–∞–Ω', '–µ–ª', '–∞—Å', '–æ', '–∞—Ä–¥', '—ä—Ä', '–∏–π', '–∏–∫', '—ä—Å', '–µ–Ω', '–æ–Ω', '—ä—Ä–¥', '–º–∞–Ω', '–≤–∞–ª–¥', '–º—ä–Ω–¥', '—Å—ä–Ω', '—Ç—ä–Ω', '—Ä–∏–∫', '–≤—ä–Ω'];

        const WEST_ROOTS_F = ['–ê–ª', '–ï–ª', '–ï–º', '–ê–º', '–ò–∑–∞', '–û–ª–∏', '–ú–∏', '–ö–∞', '–°–æ', '–î–∂—É', '–ö–ª–æ', '–õ–∏–ª–∏', '–†–æ', '–ú–∞', '–ï–≤', '–ê—Ä–∏', '–°–∞', '–í–∞', '–õ–µ', '–î–∞', '–ù–∏', '–í–∏', '–ì–ª–æ', '–î–∂–µ', '–®–∞—Ä', '–ö–∞—Ä–æ'];
        const WEST_SUF_F = ['–∞', '–∏—è', '–º–∞', '–±–µ–ª–∞', '–≤–∏—è', '–Ω–¥–∞', '–ª–∏–Ω', '—Ä–∞', '—Å–∞', '–Ω–∞', '–µ—Ç–∞', '–∏–Ω–∞', '–ª–∏—è', '—Ä–∏—Å–∞', '–±–µ–ª', '–∞–Ω–∞', '–æ—Ä–∞', '–µ–ª–∞', '–Ω–∏–∫–∞', '—Å–∏', '—Å–∏–∫–∞', '–ª–∞–π–Ω', '–ª–µ—Ç'];

        const MED_ROOTS_M = ['–ú–∞—Ç', '–ê–ª–µ—Å', '–õ–µ–æ–Ω', '–õ–æ—Ä', '–ì–∞–±—Ä', '–†–∏–∫', '–¢–æ–º', '–ï–¥–æ', '–î–∏–µ', '–°–∞–Ω—Ç', '–°–µ–±', '–ê–ª–µ—Ö', '–•—É–∞–Ω', '–ö–∞—Ä–ª', '–ü–µ–¥', '–õ—É–∏—Å', '–ò–≥–Ω', '–ê–Ω–¥—Ä', '–ö–æ—Å—Ç', '–ù–∏–∫', '–Ø–Ω', '–î–∏–º', '–°–ø–∏—Ä'];
        const MED_SUF_M = ['–µ–æ', '–∞–Ω–¥—Ä–æ', '–∞—Ä–¥–æ', '–µ–Ω—Ü–æ', '–∏–µ–ª–µ', '–∞—Ä–¥–æ', '–∞–∑–æ', '–µ–≥–æ', '—è–≥–æ', '–∞—Å—Ç–∏–∞–Ω', '–∞—Å', '–æ—Å', '–∏—Å', '—Ä–æ—Å', '–π–æ—Ç–∏—Å', '–æ', '–∞—Ä–æ—Å'];

        const MED_ROOTS_F = ['–î–∂—É', '–ê—É—Ä', '–ê–ª–∏', '–î–∂–∏–Ω', '–ï–ª–µ', '–î–∂–æ—Ä', '–ú–∞—Ä', '–ö–∏–∞', '–õ—É', '–ò–∑–∞', '–ö–∞–º', '–í–∞–ª–µ', '–ö–∞—Ä', '–ë–ª–∞', '–¢–µ—Ä–µ', '–ü–∞—É', '–ï–ª–µ', '–ê–Ω–∞—Å—Ç', '–î–µ—Å–ø', '–í–∞—Å–∏–ª'];
        const MED_SUF_F = ['–ª–∏—è', '–æ—Ä–∞', '—á–µ', '–µ–≤—Ä–∞', '–æ–Ω–æ—Ä–∞', '–¥–∂–∏—è', '—Ç–∏–Ω–∞', '—Ä–∞', '—á–∏—è', '—Å–∏—è', '–º–µ–Ω', '—Å–∞', '–Ω–∫–∞', '–∑–∞', '–ª–∞', '–ª–æ—Ç–∞', '–Ω–∏', '–∞—Å–∏—è', '–∏–Ω–∞', '–∏–∫–∏'];

        const NORDIC_ROOTS = ['–ë—å–æ—Ä–Ω', '–†–∞–≥–Ω–∞—Ä', '–ò–≤–∞—Ä', '–ï—Ä–∏–∫', '–û–ª–∞—Ñ', '–°–≤–µ–Ω', '–•–∞—Ä–∞–ª–¥', '–¢–æ—Ä', '–õ–µ–π—Ñ', '–†–æ–ª–æ', '–§—Ä–µ–π—Ä', '–•–µ–Ω—Ä–∏–∫', '–õ–∞—Ä—Å', '–ù–∏–ª—Å', '–ú–∞–≥–Ω—É—Å', '–ì—É—Å—Ç–∞–≤', '–§—Ä–µ—è', '–ê—Å—Ç—Ä–∏–¥', '–°–∏–≥—Ä–∏–¥', '–ò–Ω–≥—Ä–∏–¥', '–ì–µ—Ä–¥–∞', '–•–µ–ª–≥–∞', '–°–∏–ª–≤–∏—è', '–ò–¥—É–Ω', '–ú–∞—Ç–∏–ª–¥–µ'];
        const MUSLIM_ROOTS = ['–ú–æ—Ö–∞–º–µ–¥', '–ê—Ö–º–µ–¥', '–ê–ª–∏', '–û–º–∞—Ä', '–Æ—Å—É—Ñ', '–ò–±—Ä–∞—Ö–∏–º', '–•–∞—Å–∞–Ω', '–•—é—Å–µ–∏–Ω', '–ú—É—Å—Ç–∞—Ñ–∞', '–ê–º–∏—Ä', '–¢–∞—Ä–∏–∫', '–•–∞–ª–∏–¥', '–ó–∞–∏–¥', '–ö–∞—Ä–∏–º', '–î–∂–∞–º–∞–ª', '–°–∞–º–∏—Ä', '–Ø—Å–∏–Ω', '–§–∞—Ç–∏–º–∞', '–ê–π—à–µ', '–•–∞–¥–∏–¥–∂–∞', '–ó–∞–π–Ω–∞–±', '–ú–∞—Ä–∏—è–º', '–ê–º–∏–Ω–∞', '–õ–µ–π–ª–∞', '–Ø—Å–º–∏–Ω', '–ù—É—Ä–∞', '–ê–ª–∏—è', '–ó–∞—Ä–∞', '–ú–µ–ª–µ–∫', '–î–µ—Ñ–Ω–µ'];
        const MYTH_ROOTS = ['–ê—Ö–∏–ª', '–•–µ–∫—Ç–æ—Ä', '–ü–∞—Ä–∏—Å', '–ê–ø–æ–ª–æ–Ω', '–ê—Ä–µ—Å', '–•–µ—Ä–º–µ—Å', '–ü–µ—Ä—Å–µ–π', '–¢–µ–∑–µ–π', '–Ø–∑–æ–Ω', '–û–¥–∏—Å–µ–π', '–ï–Ω–µ–π', '–û—Ä—Ñ–µ–π', '–õ–æ–∫–∏', '–û–¥–∏–Ω', '–ê—Ç–∏–Ω–∞', '–ê—Ñ—Ä–æ–¥–∏—Ç–∞', '–•–µ—Ä–∞', '–ê—Ä—Ç–µ–º–∏–¥–∞', '–î–µ–º–µ—Ç—Ä–∞', '–ï–ª–µ–Ω–∞', '–ö–∞—Å–∞–Ω–¥—Ä–∞', '–ü–µ–Ω–µ–ª–æ–ø–∞', '–ö–∞–ª–∏–ø—Å–æ', '–ö–∏—Ä–∫–∞', '–î–∞—Ñ–Ω–µ'];

        const CULTURES = [
            { val: 'any', label: '–í—Å–∏—á–∫–∏ (–ì–ª–æ–±–∞–ª–Ω–æ)' },
            { val: 'bg', label: '–ë—ä–ª–≥–∞—Ä—Å–∫–∏ / –°–ª–∞–≤—è–Ω—Å–∫–∏' },
            { val: 'western', label: '–ó–∞–ø–∞–¥–Ω–∏ (–ê–Ω–≥–ª, –ù–µ–º—Å–∫–∏...)' },
            { val: 'mediterranean', label: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏' },
            { val: 'nordic', label: '–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏' },
            { val: 'muslim', label: '–ò—Å–ª—è–º—Å–∫–∏ / –ê—Ä–∞–±—Å–∫–∏' },
            { val: 'myth', label: '–ú–∏—Ç–æ–ª–æ–≥–∏—á–Ω–∏' }
        ];

        let NAMES_DB = [];

        function generateMassiveDB() {
            let db = [];
            BG_ROOTS.forEach(root => {
                BG_SUF_M.forEach(suf => db.push({ name: root.r + suf, gender: 'm', culture: ['bg', 'any'], meaning: `–ù–æ—Å–µ—â ${root.m} (–°–ª–∞–≤—è–Ω—Å–∫–∏ –∫–æ—Ä–µ–Ω)` }));
                BG_SUF_F.forEach(suf => db.push({ name: root.r + suf, gender: 'f', culture: ['bg', 'any'], meaning: `–ù–æ—Å–µ—â–∞ ${root.m} (–°–ª–∞–≤—è–Ω—Å–∫–∏ –∫–æ—Ä–µ–Ω)` }));
            });
            WEST_ROOTS_M.forEach(root => WEST_SUF_M.forEach(suf => db.push({ name: root + suf, gender: 'm', culture: ['western', 'any'], meaning: '–ú–æ–¥–µ—Ä–Ω–æ –∑–∞–ø–∞–¥–Ω–æ –∏–º–µ' })));
            WEST_ROOTS_F.forEach(root => WEST_SUF_F.forEach(suf => db.push({ name: root + suf, gender: 'f', culture: ['western', 'any'], meaning: '–ú–æ–¥–µ—Ä–Ω–æ –∑–∞–ø–∞–¥–Ω–æ –∏–º–µ' })));
            MED_ROOTS_M.forEach(root => MED_SUF_M.forEach(suf => db.push({ name: root + suf, gender: 'm', culture: ['mediterranean', 'any'], meaning: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏ / –Æ–∂–µ–Ω –ø—Ä–æ–∏–∑—Ö–æ–¥' })));
            MED_ROOTS_F.forEach(root => MED_SUF_F.forEach(suf => db.push({ name: root + suf, gender: 'f', culture: ['mediterranean', 'any'], meaning: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏ / –Æ–∂–µ–Ω –ø—Ä–æ–∏–∑—Ö–æ–¥' })));
            NORDIC_ROOTS.forEach((name, i) => db.push({ name, gender: i < 16 ? 'm' : 'f', culture: ['nordic', 'any'], meaning: '–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–æ / –°–µ–≤–µ—Ä–Ω–æ –∏–º–µ' }));
            MUSLIM_ROOTS.forEach((name, i) => db.push({ name, gender: i < 17 ? 'm' : 'f', culture: ['muslim', 'any'], meaning: '–ò—Å–ª—è–º—Å–∫–∏ / –ê—Ä–∞–±—Å–∫–∏ –ø—Ä–æ–∏–∑—Ö–æ–¥' }));
            MYTH_ROOTS.forEach((name, i) => db.push({ name, gender: i < 14 ? 'm' : 'f', culture: ['myth', 'any'], meaning: '–î—Ä–µ–≤–Ω–æ –º–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–º–µ' }));
            return db;
        }

        // ==========================================
        // 2. –°–™–°–¢–û–Ø–ù–ò–ï –ù–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–ï–¢–û (STATE)
        // ==========================================
        
        let currentState = {
            step: 1,
            formData: {
                gender: 'any',
                culture: 'any',
                motherName: '',
                fatherName: '',
                lastName: '',
                grandparent1: '',
                grandparent2: '',
                grandparent3: '',
                grandparent4: '',
                preferredLetter: ''
            },
            generatedNames: [],
            favorites: []
        };

        // ==========================================
        // 3. –ü–û–ú–û–©–ù–ò –§–£–ù–ö–¶–ò–ò
        // ==========================================
        
        function getPatronymic(fatherName, childGender) {
            if (!fatherName) return '';
            const name = fatherName.trim();
            if (name.length < 2) return '';
            
            const lowerName = name.toLowerCase();
            let base = name;
            let suffixM = '–æ–≤';
            let suffixF = '–æ–≤–∞';

            if (lowerName.endsWith('—ä—Ä')) {
                base = name.slice(0, -2) + '—Ä';
            } else if (lowerName.endsWith('—á–æ')) {
                base = name.slice(0, -1);
                suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
            } else if (lowerName.endsWith('—å–æ')) {
                base = name.slice(0, -2);
                suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
            } else if (lowerName.endsWith('–æ')) {
                base = name.slice(0, -1);
            } else if (lowerName.endsWith('–µ')) {
                base = name.slice(0, -1);
                suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
            } else if (lowerName.endsWith('–π')) {
                base = name.slice(0, -1);
                suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
            } else if (lowerName.endsWith('–∏')) {
                base = name.slice(0, -1);
                suffixM = '–∏–µ–≤'; suffixF = '–∏–µ–≤–∞';
            } else if (lowerName.endsWith('—è')) {
                base = name.slice(0, -1);
                suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
            } else if (lowerName.endsWith('–∞')) {
                base = name.slice(0, -1);
            }
            
            return childGender === 'm' ? base + suffixM : base + suffixF;
        }

        const isVowel = (char) => /[–∞–µ–∏–æ—É—è—é–ê–ï–ò–û–£–Ø–Æ]/i.test(char);

        // ==========================================
        // 4. UI –ò –õ–û–ì–ò–ö–ê
        // ==========================================

        function initApp() {
            NAMES_DB = generateMassiveDB();
            document.getElementById('db-count-badge').textContent = `–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏: ${NAMES_DB.length.toLocaleString('bg-BG')} –∏–º–µ–Ω–∞ –æ—Ç —Ü—è–ª —Å–≤—è—Ç`;
            
            // Render culture options
            const cultureContainer = document.getElementById('culture-options');
            cultureContainer.innerHTML = CULTURES.map(opt => `
                <label class="flex items-center p-4 rounded-2xl border-2 cursor-pointer transition-all ${currentState.formData.culture === opt.val ? 'border-purple-500 bg-purple-50' : 'border-gray-100 hover:bg-gray-50'}" onclick="selectCulture('${opt.val}')" id="cult-lbl-${opt.val}">
                    <input type="radio" name="culture" value="${opt.val}" ${currentState.formData.culture === opt.val ? 'checked' : ''} class="w-5 h-5 text-purple-600 border-gray-300 focus:ring-purple-500"/>
                    <span class="ml-3 font-medium text-gray-700">${opt.label}</span>
                </label>
            `).join('');

            lucide.createIcons();
        }

        function selectGender(val) {
            currentState.formData.gender = val;
            
            // Reset styles
            ['m', 'f', 'any'].forEach(g => {
                const btn = document.getElementById(`btn-gender-${g}`);
                btn.className = 'p-4 rounded-2xl border-2 transition-all border-gray-100';
                if(g === 'm') btn.classList.add('hover:border-blue-200', 'hover:bg-blue-50/50');
                if(g === 'f') btn.classList.add('hover:border-pink-200', 'hover:bg-pink-50/50');
                if(g === 'any') btn.classList.add('hover:border-purple-200', 'hover:bg-purple-50/50');
            });

            // Set active style
            const activeBtn = document.getElementById(`btn-gender-${val}`);
            if(val === 'm') activeBtn.className = 'p-4 rounded-2xl border-2 transition-all border-blue-500 bg-blue-50 text-blue-700';
            if(val === 'f') activeBtn.className = 'p-4 rounded-2xl border-2 transition-all border-pink-500 bg-pink-50 text-pink-700';
            if(val === 'any') activeBtn.className = 'p-4 rounded-2xl border-2 transition-all border-purple-500 bg-purple-50 text-purple-700';
        }

        function selectCulture(val) {
            currentState.formData.culture = val;
            
            // Update UI for radio buttons
            CULTURES.forEach(opt => {
                const lbl = document.getElementById(`cult-lbl-${opt.val}`);
                const radio = lbl.querySelector('input');
                if (opt.val === val) {
                    lbl.className = 'flex items-center p-4 rounded-2xl border-2 cursor-pointer transition-all border-purple-500 bg-purple-50';
                    radio.checked = true;
                } else {
                    lbl.className = 'flex items-center p-4 rounded-2xl border-2 cursor-pointer transition-all border-gray-100 hover:bg-gray-50';
                    radio.checked = false;
                }
            });
        }

        function goToStep(stepNum) {
            // Hide all steps
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            
            // Check if step is 4 to hide progress bar
            if (stepNum === 4) {
                document.getElementById('progress-section').style.display = 'none';
            } else {
                document.getElementById('progress-section').style.display = 'block';
                // Update Progress bar
                document.getElementById('progress-bar').style.width = `${(stepNum / 3) * 100}%`;
                for(let i=1; i<=3; i++) {
                    const txt = document.getElementById(`prog-text-${i}`);
                    if(stepNum >= i) txt.classList.add('text-indigo-600');
                    else txt.classList.remove('text-indigo-600');
                }
            }

            // Show target step
            document.getElementById(`step-${stepNum}`).classList.add('active');
            currentState.step = stepNum;
        }

        function readInputs() {
            currentState.formData.lastName = document.getElementById('inp-lastName').value;
            currentState.formData.fatherName = document.getElementById('inp-fatherName').value;
            currentState.formData.motherName = document.getElementById('inp-motherName').value;
            currentState.formData.preferredLetter = document.getElementById('inp-preferredLetter').value;
            currentState.formData.grandparent1 = document.getElementById('inp-gp1').value;
            currentState.formData.grandparent2 = document.getElementById('inp-gp2').value;
            currentState.formData.grandparent3 = document.getElementById('inp-gp3').value;
            currentState.formData.grandparent4 = document.getElementById('inp-gp4').value;
        }

        function generateNamesBtnClick() {
            readInputs();
            
            // Show loading
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('loading-screen').classList.remove('hidden');
            
            setTimeout(() => {
                runAlgorithm();
                
                document.getElementById('loading-screen').classList.add('hidden');
                renderResults();
                goToStep(4);
            }, 3500); // –°–∏–º—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ –≤—Ä–µ–º–µ –∑–∞ —Ç–µ–∂—ä–∫ –∞–Ω–∞–ª–∏–∑
        }

        function runAlgorithm() {
            let results = [];
            const formData = currentState.formData;
            
            const grandparents = [
                formData.grandparent1.trim(), formData.grandparent2.trim(),
                formData.grandparent3.trim(), formData.grandparent4.trim()
            ].filter(Boolean);

            const parents = [
                formData.motherName.trim(), formData.fatherName.trim()
            ].filter(Boolean);

            let pool = NAMES_DB;
            if (formData.gender !== 'any') {
                pool = pool.filter(n => n.gender === formData.gender);
            }
            if (formData.culture !== 'any') {
                pool = pool.filter(n => n.culture.includes(formData.culture));
            }

            const lastName = formData.lastName.trim();
            const prefLetter = formData.preferredLetter.trim().charAt(0).toUpperCase();

            pool.forEach(nameObj => {
                let score = 0;
                let reasons = [];
                const nameStr = nameObj.name;
                const firstLetter = nameStr.charAt(0).toUpperCase();
                
                const patronymic = getPatronymic(formData.fatherName, nameObj.gender);
                
                if (prefLetter && firstLetter === prefLetter) {
                    score += 150;
                    reasons.push(`–ó–∞–ø–æ—á–≤–∞ —Å –∂–µ–ª–∞–Ω–∞—Ç–∞ –æ—Ç –≤–∞—Å –±—É–∫–≤–∞ "${prefLetter}".`);
                }

                grandparents.forEach(gp => {
                    const gpFirstLetter = gp.charAt(0).toUpperCase();
                    const gpPrefix3 = gp.substring(0, 3).toLowerCase();
                    const namePrefix3 = nameStr.substring(0, 3).toLowerCase();
                    
                    if (gp.length >= 3 && gpPrefix3 === namePrefix3) {
                        score += 80;
                        if (!reasons.some(r => r.includes(gp))) reasons.push(`–§–æ–Ω–µ—Ç–∏—á–Ω–æ –ø—Ä–æ–¥—ä–ª–∂–µ–Ω–∏–µ –Ω–∞ ${gp}.`);
                    } else if (gpFirstLetter === firstLetter) {
                        score += 50;
                        if (!reasons.some(r => r.includes(gpFirstLetter))) reasons.push(`–ó–∞–ø–æ—á–≤–∞ —Å "${firstLetter}", –∫—Ä—ä—Å—Ç–µ–Ω–æ –Ω–∞ ${gp}.`);
                    }
                });

                parents.forEach(p => {
                    if (p.charAt(0).toUpperCase() === firstLetter) {
                        score += 20;
                        reasons.push(`–ù–æ—Å–∏ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ –±—É–∫–≤–∞ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª ("${firstLetter}").`);
                    }
                });

                if (lastName) {
                    const firstEndsWithVowel = isVowel(nameStr.slice(-1));
                    const lastStartsWithVowel = isVowel(lastName.charAt(0));
                    
                    if (firstEndsWithVowel !== lastStartsWithVowel) {
                        score += 15;
                        reasons.push("–°—ä–∑–¥–∞–≤–∞ –ø–ª–∞–≤–µ–Ω –ø—Ä–µ—Ö–æ–¥ —Å —Ñ–∞–º–∏–ª–∏—è—Ç–∞.");
                    } else {
                        score -= 5;
                    }
                    
                    if (lastName.length > 8 && nameStr.length <= 5) {
                        score += 10;
                        reasons.push("–ö—Ä–∞—Ç–∫–æ—Ç–æ –∏–º–µ –±–∞–ª–∞–Ω—Å–∏—Ä–∞ –¥—ä–ª–≥–∞—Ç–∞ —Ñ–∞–º–∏–ª–∏—è.");
                    } else if (lastName.length <= 5 && nameStr.length > 6) {
                        score += 10;
                        reasons.push("–î—ä–ª–≥–æ—Ç–æ –∏–º–µ –ø—Ä–∏–¥–∞–≤–∞ —Ç–µ–∂–µ—Å—Ç –Ω–∞ –∫—Ä–∞—Ç–∫–∞—Ç–∞ —Ñ–∞–º–∏–ª–∏—è.");
                    }
                }

                score += Math.floor(Math.random() * 25);

                results.push({ 
                    ...nameObj, 
                    score, 
                    reasons, 
                    fullName: `${nameStr} ${patronymic} ${lastName}`.trim().replace(/\s+/g, ' ')
                });
            });

            results.sort((a, b) => b.score - a.score);
            
            const uniqueResults = [];
            const seenNames = new Set();
            for(let r of results) {
                if(!seenNames.has(r.name)) {
                    seenNames.add(r.name);
                    uniqueResults.push(r);
                }
            }
            
            const topResults = uniqueResults.slice(0, 6).map(r => {
                if(r.reasons.length === 0) {
                    r.reasons.push(`–ë–ª–∞–≥–æ–∑–≤—É—á–Ω–æ –∏–º–µ –æ—Ç –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è.`);
                    if(formData.lastName) r.reasons.push(`–ó–≤—É—á–∏ —Ö–∞—Ä–º–æ–Ω–∏—á–Ω–æ —Å ${formData.lastName}.`);
                }
                // –í–∑–∏–º–∞–º–µ —Å–∞–º–æ —É–Ω–∏–∫–∞–ª–Ω–∏ –ø—Ä–∏—á–∏–Ω–∏, –º–∞–∫—Å 3
                r.reasons = [...new Set(r.reasons)].slice(0, 3);
                return r;
            });

            currentState.generatedNames = topResults;
        }

        function toggleFavorite(fullName) {
            // Find full object from either generated names or already in favorites
            let nameData = currentState.generatedNames.find(n => n.fullName === fullName) 
                        || currentState.favorites.find(n => n.fullName === fullName);
            
            if (!nameData) return;

            const index = currentState.favorites.findIndex(n => n.fullName === fullName);
            if (index > -1) {
                currentState.favorites.splice(index, 1);
            } else {
                currentState.favorites.push(nameData);
            }
            
            updateFavoritesBadge();
            renderResults(); // Re-render to update heart icons in step 4
            if(!document.getElementById('favorites-modal').classList.contains('hidden')) {
                renderFavoritesList(); // Update modal if open
            }
        }

        function updateFavoritesBadge() {
            const count = currentState.favorites.length;
            const badge = document.getElementById('fav-count-badge');
            const heartIcon = document.getElementById('header-heart-icon');
            
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
                heartIcon.classList.add('fill-current');
            } else {
                badge.classList.add('hidden');
                heartIcon.classList.remove('fill-current');
            }
        }

        function renderResults() {
            const container = document.getElementById('results-container');
            container.innerHTML = currentState.generatedNames.map((nameData, index) => {
                const isFav = currentState.favorites.some(f => f.fullName === nameData.fullName);
                const colorTheme = nameData.gender === 'm' ? 'blue' : 'pink';
                const bgTheme = nameData.gender === 'm' ? 'border-blue-100 bg-gradient-to-br from-white to-blue-50/50' : 'border-pink-100 bg-gradient-to-br from-white to-pink-50/50';
                const heartClass = isFav ? 'bg-pink-100 text-pink-500' : 'bg-white/50 text-gray-400 hover:bg-white hover:text-pink-400';
                const heartFill = isFav ? 'fill-current' : 'none';
                
                let reasonsHtml = nameData.reasons.map(reason => `
                    <li class="text-sm text-gray-700 flex items-start gap-2 leading-tight">
                        <span class="text-${colorTheme}-400 mt-0.5">‚Ä¢</span> ${reason}
                    </li>
                `).join('');

                let topChoiceBadge = index === 0 ? `
                    <div class="absolute -top-3 -right-3 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full flex items-center shadow-sm z-10">
                        <i data-lucide="sparkles" class="w-3 h-3 mr-1"></i> –¢–æ–ø –∏–∑–±–æ—Ä
                    </div>
                ` : '';

                return `
                    <div class="relative p-6 rounded-3xl border-2 shadow-sm transition-all hover:shadow-md ${bgTheme}">
                        ${topChoiceBadge}
                        <button onclick="toggleFavorite('${nameData.fullName}')" class="absolute top-4 right-4 p-2 rounded-full transition-colors z-10 ${heartClass}" title="–î–æ–±–∞–≤–∏/–ü—Ä–µ–º–∞—Ö–Ω–∏ –æ—Ç –ª—é–±–∏–º–∏">
                            <i data-lucide="heart" class="w-5 h-5 ${heartFill}"></i>
                        </button>
                        
                        <div class="mb-4 pb-4 border-b border-gray-100/80 pr-10">
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">–ü—ä–ª–Ω–æ –∏–º–µ</p>
                            <h3 class="text-2xl sm:text-3xl font-bold text-${colorTheme}-900">${nameData.fullName}</h3>
                        </div>

                        <p class="text-sm font-medium text-gray-600 mb-4">
                            –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞: <span class="text-gray-900">${nameData.meaning}</span>
                        </p>
                        
                        <div class="space-y-2">
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">–ó–∞—â–æ —Ç–æ–∑–∏ –∏–∑–±–æ—Ä?</p>
                            <ul class="space-y-1">${reasonsHtml}</ul>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons(); // Re-init icons for newly added elements
        }

        function renderFavoritesList() {
            const container = document.getElementById('favorites-container');
            if (currentState.favorites.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i data-lucide="heart" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>
                        <p>–í—Å–µ –æ—â–µ –Ω—è–º–∞—Ç–µ –∑–∞–ø–∞–∑–µ–Ω–∏ –ª—é–±–∏–º–∏ –∏–º–µ–Ω–∞.</p>
                        <button onclick="closeFavorites()" class="mt-4 text-pink-600 font-medium hover:underline">
                            –í—ä—Ä–Ω–µ—Ç–µ —Å–µ –∏ –∏–∑–±–µ—Ä–µ—Ç–µ
                        </button>
                    </div>
                `;
            } else {
                let listHtml = currentState.favorites.map(fav => `
                    <div class="p-4 rounded-2xl border border-gray-100 bg-gray-50 relative group">
                        <button onclick="toggleFavorite('${fav.fullName}')" class="absolute top-3 right-3 p-1.5 text-pink-500 opacity-0 group-hover:opacity-100 transition-opacity bg-white rounded-full shadow-sm" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i data-lucide="heart" class="w-4 h-4 fill-current"></i>
                        </button>
                        <h4 class="text-lg font-bold mb-1 ${fav.gender === 'm' ? 'text-blue-800' : 'text-pink-800'} pr-6">
                            ${fav.fullName}
                        </h4>
                        <p class="text-xs text-gray-500 line-clamp-2">${fav.meaning}</p>
                    </div>
                `).join('');
                container.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${listHtml}</div>`;
            }
            lucide.createIcons();
        }

        function openFavorites() {
            renderFavoritesList();
            document.getElementById('favorites-modal').classList.remove('hidden');
        }

        function closeFavorites() {
            document.getElementById('favorites-modal').classList.add('hidden');
        }

        function resetForm() {
            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ input –ø–æ–ª–µ—Ç–∞—Ç–∞
            document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
            selectGender('any');
            selectCulture('any');
            currentState.generatedNames = [];
            goToStep(1);
        }

        // Initialize on load
        window.onload = initApp;

    </script>
</body>
</html>
