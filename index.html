import React, { useState, useEffect, useMemo } from 'react';
import { Baby, Heart, Users, BookOpen, Sparkles, Search, ArrowRight, RefreshCw, FileText, Globe, X } from 'lucide-react';

// ==========================================
// 1. –î–ò–ù–ê–ú–ò–ß–ï–ù –ì–ï–ù–ï–†–ê–¢–û–† –ù–ê –ë–ê–ó–ê –î–ê–ù–ù–ò (> 25,000 –∏–º–µ–Ω–∞)
// ==========================================

// –ö–æ—Ä–µ–Ω–∏ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –°–ª–∞–≤—è–Ω—Å–∫–∏/–ë—ä–ª–≥–∞—Ä—Å–∫–∏ –∏–º–µ–Ω–∞
const BG_ROOTS = [
  { r: '–†–∞–¥', m: '—Ä–∞–¥–æ—Å—Ç' }, { r: '–ú–∏–ª', m: '–º–∏–ª–æ—Å—Ç –∏ –¥–æ–±—Ä–æ—Ç–∞' }, { r: '–ë–æ–∂', m: '–±–æ–∂–µ—Å—Ç–≤–µ–Ω–æ—Å—Ç' }, { r: '–°–ª–∞–≤', m: '—Å–ª–∞–≤–∞' },
  { r: '–°–≤–µ—Ç', m: '—Å–≤–µ—Ç–ª–∏–Ω–∞' }, { r: '–î–æ–±—Ä', m: '–¥–æ–±—Ä–æ—Ç–∞' }, { r: '–ö—Ä–∞—Å', m: '–∫—Ä–∞—Å–æ—Ç–∞' }, { r: '–í–ª–∞–¥', m: '–≤–ª–∞—Å—Ç –∏ —Å–∏–ª–∞' },
  { r: '–î—Ä–∞–≥', m: '—Å–∫—ä–ø–æ—Ü–µ–Ω–Ω–æ—Å—Ç' }, { r: '–ó–ª–∞—Ç', m: '–∑–ª–∞—Ç–æ –∏ –±–æ–≥–∞—Ç—Å—Ç–≤–æ' }, { r: '–°—Ç–∞–Ω', m: '—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç' }, { r: '–¶–≤–µ—Ç', m: '—Ü–≤–µ—Ç—è' },
  { r: '–í–µ–Ω', m: '–≤–µ–Ω—Ü–∏ –∏ –ø–æ–±–µ–¥–∞' }, { r: '–í–µ—Å', m: '–≤–µ—Å–µ–ª–∏–µ' }, { r: '–¢–∏—Ö–æ', m: '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ' }, { r: '–ñ–∏–≤', m: '–∂–∏–≤–æ—Ç' },
  { r: '–ó–¥—Ä–∞–≤', m: '–∑–¥—Ä–∞–≤–µ' }, { r: '–ò—Å–∫—Ä', m: '–∏—Å–∫—Ä–∞' }, { r: '–ü–ª–∞–º', m: '–ø–ª–∞–º—ä–∫' }, { r: '–†—É–º', m: '—Ä—É–º–µ–Ω–∏–Ω–∞' },
  { r: '–°–ø–∞—Å', m: '—Å–ø–∞—Å–µ–Ω–∏–µ' }, { r: '–°—Ç–æ–π', m: '–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ' }, { r: '–ë–ª–∞–≥–æ', m: '–±–ª–∞–≥–æ—Å—Ç' }, { r: '–ë–æ–≥–æ', m: '–±–æ–∂–∏—è –±–ª–∞–≥–æ–¥–∞—Ç' },
  { r: '–ë—Ä–∞–Ω–∏', m: '–∑–∞—â–∏—Ç–∞' }, { r: '–í–µ–ª–∏', m: '–≤–µ–ª–∏—á–∏–µ' }, { r: '–ñ–µ–ª', m: '–∂–µ–ª–∞–Ω–∏–µ' }, { r: '–õ—ä—á', m: '—Å–≤–µ—Ç–ª–∏–Ω–∞' },
  { r: '–û–≥–Ω', m: '–æ–≥—ä–Ω' }, { r: '–ü—Ä–∞–≤', m: '—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç' }, { r: '–Ø—Å–Ω', m: '—è—Å–Ω–æ—Ç–∞' }, { r: '–õ—é–±', m: '–ª—é–±–æ–≤' },
  { r: '–ú–∏—Ä', m: '–º–∏—Ä –∏ —Ö–∞—Ä–º–æ–Ω–∏—è' }, { r: '–î–µ—Å–∏', m: '–Ω–∞–¥–µ–∂–¥–∞' }, { r: '–ë–æ—è–Ω', m: '–±–æ–≥–∞—Ç—Å—Ç–≤–æ' }, { r: '–ö–∞–º–µ–Ω', m: '—Ç–≤—ä—Ä–¥–æ—Å—Ç' },
  { r: '–†–æ—Å–µ–Ω', m: '—Ä–æ—Å–∞, —Å–≤–µ–∂–µ—Å—Ç' }, { r: '–Ø–≤–æ—Ä', m: '–¥—ä—Ä–≤–æ —è–≤–æ—Ä (—Å–∏–ª–∞)' }, { r: '–ï–ª–µ–Ω', m: '–≥—Ä–∞—Ü–∏—è' }, { r: '–ë–∏—Å—Ç', m: '–±–∏—Å—Ç—Ä–æ—Ç–∞' },
  { r: '–°—Ä–µ–±—Ä', m: '—Å—Ä–µ–±—Ä–æ' }, { r: '–¢—Ä–∞–π', m: '–¥—ä–ª–≥–æ–ª–µ—Ç–∏–µ' }, { r: '–ö—Ä—ä—Å—Ç', m: '–≤—è—Ä–∞' }, { r: '–ú–∞–ª–∏–Ω', m: '—Å–ª–∞–¥–æ—Å—Ç' }
];

const BG_SUF_M = ['–æ–º–∏—Ä', '–æ—Å–ª–∞–≤', '–∞–Ω', '–∏–Ω', '–µ–Ω', '–µ–º–∏—Ä', '–∫–æ', '—á–æ', '–∏–ª', '–∏–º', '—å–æ', '—é', '–¥–∞–Ω', '–¥–∞—Ä', '–ª—é–±', '–∑–∞—Ä', '–º–∏—Ä', '—Å–ª–∞–≤', '–∞–¥–∏–Ω', '–∏—è–Ω', '–µ–ª–∏–Ω', '–µ–Ω–∏–π', '–∞—Ä–∏–π', '–∏–º–∏—Ä', '–∞—Å–ª–∞–≤', '–æ–¥–∞—Ä', '–æ–ª—é–±', '–æ–∑–∞—Ä', '–∏—Å–ª–∞–≤', '–µ—Ü', '–æ–π', '—É—à', '–µ–Ω–∫–æ', '–∞–Ω–∫–æ'];
const BG_SUF_F = ['–æ–º–∏—Ä–∞', '–æ—Å–ª–∞–≤–∞', '–∞–Ω–∞', '–∏–Ω–∞', '–µ–Ω–∞', '–µ–º–∏—Ä–∞', '–∫–∞', '—á–∫–∞', '–∏–ª–∞', '–∏–º–∞', '—è', '—è–Ω–∞', '–¥–∞–Ω–∞', '–¥–∞—Ä–∞', '–ª—é–±–∞', '–∑–∞—Ä–∞', '–º–∏—Ä–∞', '—Å–ª–∞–≤–∞', '–∏—è–Ω–∞', '–µ–ª–∏–Ω–∞', '–µ–Ω–∏—è', '–∞—Ä–∏—è', '–∏–º–∏—Ä–∏', '–∞—Å–ª–∞–≤–∞', '–æ–¥–∞—Ä–∞', '–æ–ª—é–±–∞', '–µ—Ç–∞', '—É—à–∞', '–µ–Ω–∫–∞', '–∞–Ω–∫–∞'];

// –ö–æ—Ä–µ–Ω–∏ –∑–∞ –ó–∞–ø–∞–¥–Ω–∏/–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∏ –∏–º–µ–Ω–∞
const WEST_ROOTS_M = ['–ê–ª', '–ï–ª', '–ö—Ä–∏—Å', '–õ–µ–æ', '–î–∞–Ω', '–°–∞–º', '–û–ª–∏', '–ë–µ–Ω', '–ì–∞–±', '–ù–∏–∫', '–¢–µ–æ', '–ú–∞–∫—Å', '–õ—É–∫', '–ú–∞—Ä', '–§–µ–ª', '–ê–Ω—Ç', '–í–∞–ª', '–†–æ–º', '–°–∏–ª', '–§–ª–æ—Ä', '–Æ–ª', '–ê–≤–≥', '–ï–¥', '–†–∏—á', '–ê—Ä', '–î–∂–µ–π', '–î–∂–æ–Ω', '–†–æ–±', '–£–∏–ª', '–†–∏–∫'];
const WEST_SUF_M = ['–±—ä—Ä—Ç', '–∫—Å', '—Å', '–Ω', '–∞–º', '–∏', '–∏–∞–Ω', '–µ–ª', '–∞—Å', '–æ', '–∞—Ä–¥', '—ä—Ä', '–∏–π', '–∏–∫', '—ä—Å', '–µ–Ω', '–æ–Ω', '—ä—Ä–¥', '–º–∞–Ω', '–≤–∞–ª–¥', '–º—ä–Ω–¥', '—Å—ä–Ω', '—Ç—ä–Ω', '—Ä–∏–∫', '–≤—ä–Ω'];

const WEST_ROOTS_F = ['–ê–ª', '–ï–ª', '–ï–º', '–ê–º', '–ò–∑–∞', '–û–ª–∏', '–ú–∏', '–ö–∞', '–°–æ', '–î–∂—É', '–ö–ª–æ', '–õ–∏–ª–∏', '–†–æ', '–ú–∞', '–ï–≤', '–ê—Ä–∏', '–°–∞', '–í–∞', '–õ–µ', '–î–∞', '–ù–∏', '–í–∏', '–ì–ª–æ', '–î–∂–µ', '–®–∞—Ä', '–ö–∞—Ä–æ'];
const WEST_SUF_F = ['–∞', '–∏—è', '–º–∞', '–±–µ–ª–∞', '–≤–∏—è', '–Ω–¥–∞', '–ª–∏–Ω', '—Ä–∞', '—Å–∞', '–Ω–∞', '–µ—Ç–∞', '–∏–Ω–∞', '–ª–∏—è', '—Ä–∏—Å–∞', '–±–µ–ª', '–∞–Ω–∞', '–æ—Ä–∞', '–µ–ª–∞', '–Ω–∏–∫–∞', '—Å–∏', '—Å–∏–∫–∞', '–ª–∞–π–Ω', '–ª–µ—Ç'];

// –°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏ (–ò—Å–ø–∞–Ω—Å–∫–∏/–ò—Ç–∞–ª–∏–∞–Ω—Å–∫–∏/–ì—Ä—ä—Ü–∫–∏)
const MED_ROOTS_M = ['–ú–∞—Ç', '–ê–ª–µ—Å', '–õ–µ–æ–Ω', '–õ–æ—Ä', '–ì–∞–±—Ä', '–†–∏–∫', '–¢–æ–º', '–ï–¥–æ', '–î–∏–µ', '–°–∞–Ω—Ç', '–°–µ–±', '–ê–ª–µ—Ö', '–•—É–∞–Ω', '–ö–∞—Ä–ª', '–ü–µ–¥', '–õ—É–∏—Å', '–ò–≥–Ω', '–ê–Ω–¥—Ä', '–ö–æ—Å—Ç', '–ù–∏–∫', '–Ø–Ω', '–î–∏–º', '–°–ø–∏—Ä'];
const MED_SUF_M = ['–µ–æ', '–∞–Ω–¥—Ä–æ', '–∞—Ä–¥–æ', '–µ–Ω—Ü–æ', '–∏–µ–ª–µ', '–∞—Ä–¥–æ', '–∞–∑–æ', '–µ–≥–æ', '—è–≥–æ', '–∞—Å—Ç–∏–∞–Ω', '–∞—Å', '–æ—Å', '–∏—Å', '—Ä–æ—Å', '–π–æ—Ç–∏—Å', '–æ', '–∞—Ä–æ—Å'];

const MED_ROOTS_F = ['–î–∂—É', '–ê—É—Ä', '–ê–ª–∏', '–î–∂–∏–Ω', '–ï–ª–µ', '–î–∂–æ—Ä', '–ú–∞—Ä', '–ö–∏–∞', '–õ—É', '–ò–∑–∞', '–ö–∞–º', '–í–∞–ª–µ', '–ö–∞—Ä', '–ë–ª–∞', '–¢–µ—Ä–µ', '–ü–∞—É', '–ï–ª–µ', '–ê–Ω–∞—Å—Ç', '–î–µ—Å–ø', '–í–∞—Å–∏–ª'];
const MED_SUF_F = ['–ª–∏—è', '–æ—Ä–∞', '—á–µ', '–µ–≤—Ä–∞', '–æ–Ω–æ—Ä–∞', '–¥–∂–∏—è', '—Ç–∏–Ω–∞', '—Ä–∞', '—á–∏—è', '—Å–∏—è', '–º–µ–Ω', '—Å–∞', '–Ω–∫–∞', '–∑–∞', '–ª–∞', '–ª–æ—Ç–∞', '–Ω–∏', '–∞—Å–∏—è', '–∏–Ω–∞', '–∏–∫–∏'];

// –°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏
const NORDIC_ROOTS = ['–ë—å–æ—Ä–Ω', '–†–∞–≥–Ω–∞—Ä', '–ò–≤–∞—Ä', '–ï—Ä–∏–∫', '–û–ª–∞—Ñ', '–°–≤–µ–Ω', '–•–∞—Ä–∞–ª–¥', '–¢–æ—Ä', '–õ–µ–π—Ñ', '–†–æ–ª–æ', '–§—Ä–µ–π—Ä', '–•–µ–Ω—Ä–∏–∫', '–õ–∞—Ä—Å', '–ù–∏–ª—Å', '–ú–∞–≥–Ω—É—Å', '–ì—É—Å—Ç–∞–≤', '–§—Ä–µ—è', '–ê—Å—Ç—Ä–∏–¥', '–°–∏–≥—Ä–∏–¥', '–ò–Ω–≥—Ä–∏–¥', '–ì–µ—Ä–¥–∞', '–•–µ–ª–≥–∞', '–°–∏–ª–≤–∏—è', '–ò–¥—É–Ω', '–ú–∞—Ç–∏–ª–¥–µ'];

// –ò—Å–ª—è–º—Å–∫–∏ / –ê—Ä–∞–±—Å–∫–∏
const MUSLIM_ROOTS = ['–ú–æ—Ö–∞–º–µ–¥', '–ê—Ö–º–µ–¥', '–ê–ª–∏', '–û–º–∞—Ä', '–Æ—Å—É—Ñ', '–ò–±—Ä–∞—Ö–∏–º', '–•–∞—Å–∞–Ω', '–•—é—Å–µ–∏–Ω', '–ú—É—Å—Ç–∞—Ñ–∞', '–ê–º–∏—Ä', '–¢–∞—Ä–∏–∫', '–•–∞–ª–∏–¥', '–ó–∞–∏–¥', '–ö–∞—Ä–∏–º', '–î–∂–∞–º–∞–ª', '–°–∞–º–∏—Ä', '–Ø—Å–∏–Ω', '–§–∞—Ç–∏–º–∞', '–ê–π—à–µ', '–•–∞–¥–∏–¥–∂–∞', '–ó–∞–π–Ω–∞–±', '–ú–∞—Ä–∏—è–º', '–ê–º–∏–Ω–∞', '–õ–µ–π–ª–∞', '–Ø—Å–º–∏–Ω', '–ù—É—Ä–∞', '–ê–ª–∏—è', '–ó–∞—Ä–∞', '–ú–µ–ª–µ–∫', '–î–µ—Ñ–Ω–µ'];

// –ê–Ω—Ç–∏—á–Ω–∏ / –ú–∏—Ç–æ–ª–æ–≥–∏—á–Ω–∏
const MYTH_ROOTS = ['–ê—Ö–∏–ª', '–•–µ–∫—Ç–æ—Ä', '–ü–∞—Ä–∏—Å', '–ê–ø–æ–ª–æ–Ω', '–ê—Ä–µ—Å', '–•–µ—Ä–º–µ—Å', '–ü–µ—Ä—Å–µ–π', '–¢–µ–∑–µ–π', '–Ø–∑–æ–Ω', '–û–¥–∏—Å–µ–π', '–ï–Ω–µ–π', '–û—Ä—Ñ–µ–π', '–õ–æ–∫–∏', '–û–¥–∏–Ω', '–ê—Ç–∏–Ω–∞', '–ê—Ñ—Ä–æ–¥–∏—Ç–∞', '–•–µ—Ä–∞', '–ê—Ä—Ç–µ–º–∏–¥–∞', '–î–µ–º–µ—Ç—Ä–∞', '–ï–ª–µ–Ω–∞', '–ö–∞—Å–∞–Ω–¥—Ä–∞', '–ü–µ–Ω–µ–ª–æ–ø–∞', '–ö–∞–ª–∏–ø—Å–æ', '–ö–∏—Ä–∫–∞', '–î–∞—Ñ–Ω–µ'];

const generateMassiveDB = () => {
  let db = [];
  
  // 1. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ë—ä–ª–≥–∞—Ä—Å–∫–∏ / –°–ª–∞–≤—è–Ω—Å–∫–∏
  BG_ROOTS.forEach(root => {
    BG_SUF_M.forEach(suf => db.push({ name: root.r + suf, gender: 'm', culture: ['bg', 'any'], meaning: `–ù–æ—Å–µ—â ${root.m} (–°–ª–∞–≤—è–Ω—Å–∫–∏ –∫–æ—Ä–µ–Ω)` }));
    BG_SUF_F.forEach(suf => db.push({ name: root.r + suf, gender: 'f', culture: ['bg', 'any'], meaning: `–ù–æ—Å–µ—â–∞ ${root.m} (–°–ª–∞–≤—è–Ω—Å–∫–∏ –∫–æ—Ä–µ–Ω)` }));
  });

  // 2. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ó–∞–ø–∞–¥–Ω–∏
  WEST_ROOTS_M.forEach(root => WEST_SUF_M.forEach(suf => db.push({ name: root + suf, gender: 'm', culture: ['western', 'any'], meaning: '–ú–æ–¥–µ—Ä–Ω–æ –∑–∞–ø–∞–¥–Ω–æ –∏–º–µ' })));
  WEST_ROOTS_F.forEach(root => WEST_SUF_F.forEach(suf => db.push({ name: root + suf, gender: 'f', culture: ['western', 'any'], meaning: '–ú–æ–¥–µ—Ä–Ω–æ –∑–∞–ø–∞–¥–Ω–æ –∏–º–µ' })));

  // 3. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏
  MED_ROOTS_M.forEach(root => MED_SUF_M.forEach(suf => db.push({ name: root + suf, gender: 'm', culture: ['mediterranean', 'any'], meaning: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏ / –Æ–∂–µ–Ω –ø—Ä–æ–∏–∑—Ö–æ–¥' })));
  MED_ROOTS_F.forEach(root => MED_SUF_F.forEach(suf => db.push({ name: root + suf, gender: 'f', culture: ['mediterranean', 'any'], meaning: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏ / –Æ–∂–µ–Ω –ø—Ä–æ–∏–∑—Ö–æ–¥' })));

  // 4. –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏ (—Å—Ç–∞—Ç–∏—á–Ω–∏, –∑–∞—â–æ—Ç–æ —Å–µ –∫–æ–º–±–∏–Ω–∏—Ä–∞—Ç —Ç—Ä—É–¥–Ω–æ —Ñ–æ–Ω–µ—Ç–∏—á–Ω–æ)
  NORDIC_ROOTS.forEach((name, i) => db.push({ name, gender: i < 16 ? 'm' : 'f', culture: ['nordic', 'any'], meaning: '–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–æ / –°–µ–≤–µ—Ä–Ω–æ –∏–º–µ' }));

  // 5. –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ò—Å–ª—è–º—Å–∫–∏
  MUSLIM_ROOTS.forEach((name, i) => db.push({ name, gender: i < 17 ? 'm' : 'f', culture: ['muslim', 'any'], meaning: '–ò—Å–ª—è–º—Å–∫–∏ / –ê—Ä–∞–±—Å–∫–∏ –ø—Ä–æ–∏–∑—Ö–æ–¥' }));

  // 6. –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ú–∏—Ç–æ–ª–æ–≥–∏—á–Ω–∏
  MYTH_ROOTS.forEach((name, i) => db.push({ name, gender: i < 14 ? 'm' : 'f', culture: ['myth', 'any'], meaning: '–î—Ä–µ–≤–Ω–æ –º–∏—Ç–æ–ª–æ–≥–∏—á–Ω–æ –∏–º–µ' }));

  return db;
};

// ==========================================
// 2. –£–°–™–í–™–†–®–ï–ù–°–¢–í–ê–ù–ò –ü–†–ê–í–ò–õ–ê –ó–ê –ü–†–ï–ó–ò–ú–ï
// ==========================================

const getPatronymic = (fatherName, childGender) => {
  if (!fatherName) return '';
  const name = fatherName.trim();
  if (name.length < 2) return '';
  
  const lowerName = name.toLowerCase();
  let base = name;
  let suffixM = '–æ–≤';
  let suffixF = '–æ–≤–∞';

  // –ò–∑–∫–ª—é—á–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª–∞ –≤ –±—ä–ª–≥–∞—Ä—Å–∫–∏—è –µ–∑–∏–∫
  if (lowerName.endsWith('—ä—Ä')) {
    base = name.slice(0, -2) + '—Ä'; // –ü–µ—Ç—ä—Ä -> –ü–µ—Ç—Ä–æ–≤
  } else if (lowerName.endsWith('—á–æ')) {
    base = name.slice(0, -1);       // –Ø–Ω—á–æ -> –Ø–Ω—á–µ–≤, –°—Ç–æ–π—á–æ -> –°—Ç–æ–π—á–µ–≤
    suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
  } else if (lowerName.endsWith('—å–æ')) {
    base = name.slice(0, -2);       // –ü–µ—Ç—å–æ -> –ü–µ—Ç–µ–≤, –ö–æ–ª—å–æ -> –ö–æ–ª–µ–≤
    suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
  } else if (lowerName.endsWith('–æ')) {
    base = name.slice(0, -1);       // –•—Ä–∏—Å—Ç–æ -> –•—Ä–∏—Å—Ç–æ–≤, –í–µ–ª–∏—á–∫–æ -> –í–µ–ª–∏—á–∫–æ–≤
  } else if (lowerName.endsWith('–µ')) {
    base = name.slice(0, -1);       // –Ø–Ω–µ -> –Ø–Ω–µ–≤, –ì–æ—Ü–µ -> –ì–æ—Ü–µ–≤
    suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
  } else if (lowerName.endsWith('–π')) {
    base = name.slice(0, -1);       // –ë–ª–∞–≥–æ–π -> –ë–ª–∞–≥–æ–µ–≤, –ù–∏–∫–æ–ª–∞–π -> –ù–∏–∫–æ–ª–∞–µ–≤
    suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
  } else if (lowerName.endsWith('–∏')) {
    base = name.slice(0, -1);       // –ì–µ–æ—Ä–≥–∏ -> –ì–µ–æ—Ä–≥–∏–µ–≤
    suffixM = '–∏–µ–≤'; suffixF = '–∏–µ–≤–∞';
  } else if (lowerName.endsWith('—è')) {
    base = name.slice(0, -1);       // –ò–ª–∏—è -> –ò–ª–∏–µ–≤
    suffixM = '–µ–≤'; suffixF = '–µ–≤–∞';
  } else if (lowerName.endsWith('–∞')) {
    base = name.slice(0, -1);       // –ù–∏–∫–æ–ª–∞ -> –ù–∏–∫–æ–ª–æ–≤, –°–∞–≤–∞ -> –°–∞–≤–æ–≤
  }
  
  return childGender === 'm' ? base + suffixM : base + suffixF;
};

const isVowel = (char) => /[–∞–µ–∏–æ—É—è—é–ê–ï–ò–û–£–Ø–Æ]/i.test(char);

// ==========================================
// 3. –û–°–ù–û–í–ï–ù –ö–û–ú–ü–û–ù–ï–ù–¢
// ==========================================

export default function App() {
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState({
    gender: 'any',
    culture: 'any', // –ü—Ä–æ–º–µ–Ω–µ–Ω–æ –æ—Ç religion –Ω–∞ culture
    motherName: '',
    fatherName: '',
    lastName: '',
    grandparent1: '',
    grandparent2: '',
    grandparent3: '',
    grandparent4: '',
    preferredLetter: '',
  });

  const [isGenerating, setIsGenerating] = useState(false);
  const [generatedNames, setGeneratedNames] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [showFavorites, setShowFavorites] = useState(false);
  
  // –ì–µ–Ω–µ—Ä–∏—Ä–∞–º–µ –±–∞–∑–∞—Ç–∞ —Å–∞–º–æ –≤–µ–¥–Ω—ä–∂ (–≤–µ—á–µ —Å—ä–¥—ä—Ä–∂–∞ –Ω–∞–¥ 25 000 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏!)
  const NAMES_DB = useMemo(() => generateMassiveDB(), []);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const CULTURES = [
    { val: 'any', label: '–í—Å–∏—á–∫–∏ (–ì–ª–æ–±–∞–ª–Ω–æ)' },
    { val: 'bg', label: '–ë—ä–ª–≥–∞—Ä—Å–∫–∏ / –°–ª–∞–≤—è–Ω—Å–∫–∏' },
    { val: 'western', label: '–ó–∞–ø–∞–¥–Ω–∏ (–ê–Ω–≥–ª, –ù–µ–º—Å–∫–∏...)' },
    { val: 'mediterranean', label: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏' },
    { val: 'nordic', label: '–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏' },
    { val: 'muslim', label: '–ò—Å–ª—è–º—Å–∫–∏ / –ê—Ä–∞–±—Å–∫–∏' },
    { val: 'myth', label: '–ú–∏—Ç–æ–ª–æ–≥–∏—á–Ω–∏' }
  ];

  const generateNames = () => {
    setIsGenerating(true);
    
    setTimeout(() => {
      let results = [];
      
      const grandparents = [
        formData.grandparent1.trim(),
        formData.grandparent2.trim(),
        formData.grandparent3.trim(),
        formData.grandparent4.trim()
      ].filter(Boolean);

      const parents = [
        formData.motherName.trim(),
        formData.fatherName.trim()
      ].filter(Boolean);

      // –§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –ø–æ –ø–æ–ª
      let pool = NAMES_DB;
      if (formData.gender !== 'any') {
        pool = pool.filter(n => n.gender === formData.gender);
      }

      // –§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –ø–æ –∫—É–ª—Ç—É—Ä–∞/–ø—Ä–æ–∏–∑—Ö–æ–¥
      if (formData.culture !== 'any') {
        pool = pool.filter(n => n.culture.includes(formData.culture));
      }

      const lastName = formData.lastName.trim();
      const prefLetter = formData.preferredLetter.trim().charAt(0).toUpperCase();

      // –û—Ü–µ–Ω—è–≤–∞–Ω–µ
      pool.forEach(nameObj => {
        let score = 0;
        let reasons = [];
        const nameStr = nameObj.name;
        const firstLetter = nameStr.charAt(0).toUpperCase();
        
        // –ü—Ä–µ–∑–∏–º–µ
        const patronymic = getPatronymic(formData.fatherName, nameObj.gender);
        
        // 0. –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∞ –±—É–∫–≤–∞ (–ù–∞–π-–≤–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
        if (prefLetter && firstLetter === prefLetter) {
          score += 150;
          reasons.push(`–ó–∞–ø–æ—á–≤–∞ —Å –∂–µ–ª–∞–Ω–∞—Ç–∞ –æ—Ç –≤–∞—Å –±—É–∫–≤–∞ "${prefLetter}".`);
        }

        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –±–∞–±–∏ –∏ –¥—è–¥–æ–≤—Ü–∏
        grandparents.forEach(gp => {
          const gpFirstLetter = gp.charAt(0).toUpperCase();
          const gpPrefix3 = gp.substring(0, 3).toLowerCase();
          const namePrefix3 = nameStr.substring(0, 3).toLowerCase();
          
          if (gp.length >= 3 && gpPrefix3 === namePrefix3) {
            score += 80;
            if (!reasons.some(r => r.includes(gp))) reasons.push(`–§–æ–Ω–µ—Ç–∏—á–Ω–æ –ø—Ä–æ–¥—ä–ª–∂–µ–Ω–∏–µ –Ω–∞ ${gp}.`);
          } else if (gpFirstLetter === firstLetter) {
            score += 50;
            if (!reasons.some(r => r.includes(gpFirstLetter))) reasons.push(`–ó–∞–ø–æ—á–≤–∞ —Å "${firstLetter}", –∫—Ä—ä—Å—Ç–µ–Ω–æ –Ω–∞ ${gp}.`);
          }
        });

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Ä–æ–¥–∏—Ç–µ–ª–∏
        parents.forEach(p => {
          if (p.charAt(0).toUpperCase() === firstLetter) {
            score += 20;
            reasons.push(`–ù–æ—Å–∏ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ –±—É–∫–≤–∞ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª ("${firstLetter}").`);
          }
        });

        // 3. –§–æ–Ω–µ—Ç–∏—á–µ–Ω —Ä–∏—Ç—ä–º —Å —Ñ–∞–º–∏–ª–∏—è—Ç–∞
        if (lastName) {
          const firstEndsWithVowel = isVowel(nameStr.slice(-1));
          const lastStartsWithVowel = isVowel(lastName.charAt(0));
          
          if (firstEndsWithVowel !== lastStartsWithVowel) {
            score += 15;
            reasons.push("–°—ä–∑–¥–∞–≤–∞ –ø–ª–∞–≤–µ–Ω –ø—Ä–µ—Ö–æ–¥ —Å —Ñ–∞–º–∏–ª–∏—è—Ç–∞.");
          } else {
            score -= 5;
          }
          
          if (lastName.length > 8 && nameStr.length <= 5) {
            score += 10;
            reasons.push("–ö—Ä–∞—Ç–∫–æ—Ç–æ –∏–º–µ –±–∞–ª–∞–Ω—Å–∏—Ä–∞ –¥—ä–ª–≥–∞—Ç–∞ —Ñ–∞–º–∏–ª–∏—è.");
          } else if (lastName.length <= 5 && nameStr.length > 6) {
            score += 10;
            reasons.push("–î—ä–ª–≥–æ—Ç–æ –∏–º–µ –ø—Ä–∏–¥–∞–≤–∞ —Ç–µ–∂–µ—Å—Ç –Ω–∞ –∫—Ä–∞—Ç–∫–∞—Ç–∞ —Ñ–∞–º–∏–ª–∏—è.");
          }
        }

        // 4. –ü—Ä–æ–∏–∑–≤–æ–ª–Ω–æ—Å—Ç –∑–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
        score += Math.floor(Math.random() * 25);

        results.push({ 
          ...nameObj, 
          score, 
          reasons, 
          fullName: `${nameStr} ${patronymic} ${lastName}`.trim().replace(/\s+/g, ' ')
        });
      });

      results.sort((a, b) => b.score - a.score);
      
      const uniqueResults = [];
      const seenNames = new Set();
      for(let r of results) {
          if(!seenNames.has(r.name)) {
              seenNames.add(r.name);
              uniqueResults.push(r);
          }
      }
      
      const topResults = uniqueResults.slice(0, 6).map(r => {
          if(r.reasons.length === 0) {
             r.reasons.push(`–ë–ª–∞–≥–æ–∑–≤—É—á–Ω–æ –∏–º–µ –æ—Ç –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è.`);
             if(formData.lastName) r.reasons.push(`–ó–≤—É—á–∏ —Ö–∞—Ä–º–æ–Ω–∏—á–Ω–æ —Å ${formData.lastName}.`);
          }
          r.reasons = [...new Set(r.reasons)].slice(0, 3);
          return r;
      });

      setGeneratedNames(topResults);
      setIsGenerating(false);
      setStep(4);
    }, 3500); // –ü–æ–≤–µ—á–µ –≤—Ä–µ–º–µ –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ –≤ –ø–æ-–≥–æ–ª–µ–º–∏—è –º–∞—Å–∏–≤
  };

  const resetForm = () => {
    setStep(1);
    setGeneratedNames([]);
  };

  const toggleFavorite = (nameData) => {
    setFavorites(prev => {
      const exists = prev.find(n => n.fullName === nameData.fullName);
      if (exists) {
        return prev.filter(n => n.fullName !== nameData.fullName);
      }
      return [...prev, nameData];
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 font-sans text-gray-800 relative">
      <header className="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-10">
        <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-2 text-indigo-600">
            <Baby className="w-8 h-8" />
            <h1 className="text-2xl font-bold tracking-tight">–ò–º–µ—Ç–æ –Ω–∞ –ß—É–¥–æ—Ç–æ</h1>
          </div>
          <div className="flex items-center gap-4">
            <div className="hidden sm:flex text-sm font-medium text-gray-500 items-center gap-1 bg-gray-100 px-3 py-1.5 rounded-full">
              <Globe className="w-4 h-4" />
              <span>–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏: {NAMES_DB.length.toLocaleString('bg-BG')} –∏–º–µ–Ω–∞ –æ—Ç —Ü—è–ª —Å–≤—è—Ç</span>
            </div>
            <button 
              onClick={() => setShowFavorites(true)}
              className="relative flex items-center gap-1 bg-pink-100 hover:bg-pink-200 text-pink-700 px-3 py-1.5 rounded-full transition-colors font-medium"
            >
              <Heart className="w-4 h-4" fill={favorites.length > 0 ? "currentColor" : "none"} />
              <span className="hidden sm:inline">–õ—é–±–∏–º–∏</span>
              {favorites.length > 0 && (
                <span className="absolute -top-1 -right-1 bg-pink-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center">
                  {favorites.length}
                </span>
              )}
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-12">
        {step < 4 && (
          <div className="mb-8">
            <div className="flex justify-between text-xs font-medium text-gray-400 mb-2 px-1">
              <span className={step >= 1 ? 'text-indigo-600' : ''}>–û—Å–Ω–æ–≤–∏</span>
              <span className={step >= 2 ? 'text-indigo-600' : ''}>–ü—Ä–æ–∏–∑—Ö–æ–¥</span>
              <span className={step >= 3 ? 'text-indigo-600' : ''}>–†–æ–¥ –∏ –§–∞–º–∏–ª–∏—è</span>
            </div>
            <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
              <div className="h-full bg-indigo-600 transition-all duration-500 ease-out" style={{ width: `${(step / 3) * 100}%` }}></div>
            </div>
          </div>
        )}

        <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-white">
          <div className="p-8 sm:p-12">
            
            {/* –°—Ç—ä–ø–∫–∞ 1: –ü–æ–ª */}
            {step === 1 && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="text-center mb-8">
                  <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Baby className="w-8 h-8" />
                  </div>
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">–ö–æ–≥–æ –æ—á–∞–∫–≤–∞—Ç–µ?</h2>
                  <p className="text-gray-500">–ù–µ–∫–∞ –∑–∞–ø–æ—á–Ω–µ–º —Å –Ω–∞–π-–≤–∞–∂–Ω–æ—Ç–æ.</p>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                  <button onClick={() => setFormData({...formData, gender: 'm'})} className={`p-4 rounded-2xl border-2 transition-all ${formData.gender === 'm' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-100 hover:border-blue-200 hover:bg-blue-50/50'}`}>
                    <div className="text-xl font-semibold mb-1">–ú–æ–º—á–µ üë¶üèª</div>
                  </button>
                  <button onClick={() => setFormData({...formData, gender: 'f'})} className={`p-4 rounded-2xl border-2 transition-all ${formData.gender === 'f' ? 'border-pink-500 bg-pink-50 text-pink-700' : 'border-gray-100 hover:border-pink-200 hover:bg-pink-50/50'}`}>
                    <div className="text-xl font-semibold mb-1">–ú–æ–º–∏—á–µ üëßüèª</div>
                  </button>
                  <button onClick={() => setFormData({...formData, gender: 'any'})} className={`p-4 rounded-2xl border-2 transition-all ${formData.gender === 'any' ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-gray-100 hover:border-purple-200 hover:bg-purple-50/50'}`}>
                    <div className="text-xl font-semibold mb-1">–ò–∑–Ω–µ–Ω–∞–¥–∞ üéÅ</div>
                  </button>
                </div>
                <div className="flex justify-end">
                  <button onClick={() => setStep(2)} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-medium transition-colors">
                    –ù–∞–ø—Ä–µ–¥ <ArrowRight className="w-5 h-5" />
                  </button>
                </div>
              </div>
            )}

            {/* –°—Ç—ä–ø–∫–∞ 2: –ö—É–ª—Ç—É—Ä–∞ –∏ –ü—Ä–æ–∏–∑—Ö–æ–¥ */}
            {step === 2 && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="text-center mb-8">
                  <div className="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Globe className="w-8 h-8" />
                  </div>
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">–ü—Ä–æ–∏–∑—Ö–æ–¥ –Ω–∞ –∏–º–µ—Ç–æ</h2>
                  <p className="text-gray-500">–†–∞–∑–ø–æ–ª–∞–≥–∞–º–µ —Å –Ω–∞–¥ 25 000 –∏–º–µ–Ω–∞ –æ—Ç —Ä–∞–∑–ª–∏—á–Ω–∏ –∫—Ä–∞–∏—â–∞ –Ω–∞ —Å–≤–µ—Ç–∞.</p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                  {CULTURES.map((option) => (
                    <label key={option.val} className={`flex items-center p-4 rounded-2xl border-2 cursor-pointer transition-all ${formData.culture === option.val ? 'border-purple-500 bg-purple-50' : 'border-gray-100 hover:bg-gray-50'}`}>
                      <input type="radio" name="culture" value={option.val} checked={formData.culture === option.val} onChange={handleInputChange} className="w-5 h-5 text-purple-600 border-gray-300 focus:ring-purple-500"/>
                      <span className="ml-3 font-medium text-gray-700">{option.label}</span>
                    </label>
                  ))}
                </div>
                <div className="flex justify-between">
                  <button onClick={() => setStep(1)} className="text-gray-500 hover:text-gray-700 px-6 py-3 font-medium transition-colors">–ù–∞–∑–∞–¥</button>
                  <button onClick={() => setStep(3)} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-medium transition-colors">
                    –ù–∞–ø—Ä–µ–¥ <ArrowRight className="w-5 h-5" />
                  </button>
                </div>
              </div>
            )}

            {/* –°—Ç—ä–ø–∫–∞ 3: –†–æ–¥ –∏ –§–∞–º–∏–ª–∏—è */}
            {step === 3 && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="text-center mb-8">
                  <div className="w-16 h-16 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Users className="w-8 h-8" />
                  </div>
                  <h2 className="text-3xl font-bold text-gray-900 mb-2">–§–∞–º–∏–ª–∏—è –∏ –†–æ–¥</h2>
                  <p className="text-gray-500">–ê–ª–≥–æ—Ä–∏—Ç—ä–º—ä—Ç –Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —â–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–≤–∞ –∏–º–µ—Ç–æ –Ω–∞ –±–∞—â–∞—Ç–∞ –≤ –ø—Ä–∞–≤–∏–ª–Ω–æ –ø—Ä–µ–∑–∏–º–µ —Å–ø–æ—Ä–µ–¥ –±—ä–ª–≥–∞—Ä—Å–∫–∞—Ç–∞ –≥—Ä–∞–º–∞—Ç–∏–∫–∞.</p>
                </div>

                <div className="space-y-6 mb-8 text-left">
                  <div className="bg-indigo-50/50 p-6 rounded-2xl border border-indigo-100">
                    <h3 className="text-lg font-semibold text-indigo-900 mb-4 flex items-center gap-2">
                      <FileText className="w-5 h-5 text-indigo-500" /> –û—Å–Ω–æ–≤–Ω–∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–ó–∞ –ø—ä–ª–Ω–æ—Ç–æ –∏–º–µ)
                    </h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                      <div className="sm:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">–§–∞–º–∏–ª–∏—è –Ω–∞ –¥–µ—Ç–µ—Ç–æ</label>
                        <input type="text" name="lastName" value={formData.lastName} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –ì–µ–æ—Ä–≥–∏–µ–≤ / –ì–µ–æ—Ä–≥–∏–µ–≤–∞"/>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">–ò–º–µ –Ω–∞ –±–∞—â–∞—Ç–∞ (–∑–∞ –ü—Ä–µ–∑–∏–º–µ)</label>
                        <input type="text" name="fatherName" value={formData.fatherName} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –Ø–Ω—á–æ (—â–µ —Å—Ç–∞–Ω–µ –Ø–Ω—á–µ–≤)"/>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">–ò–º–µ –Ω–∞ –º–∞–π–∫–∞—Ç–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)</label>
                        <input type="text" name="motherName" value={formData.motherName} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="–Ω–∞–ø—Ä. –ú–∞—Ä–∏—è"/>
                      </div>
                      <div className="sm:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">–ñ–µ–ª–∞–Ω–∞ –ø—ä—Ä–≤–∞ –±—É–∫–≤–∞ (–ø–æ –∏–∑–±–æ—Ä)</label>
                        <input type="text" name="preferredLetter" maxLength="1" value={formData.preferredLetter} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all uppercase" placeholder="–Ω–∞–ø—Ä. –ê"/>
                      </div>
                    </div>
                  </div>

                  <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                      <Heart className="w-5 h-5 text-pink-500" /> –ò–º–µ–Ω–∞ –Ω–∞ –±–∞–±–∏ –∏ –¥—è–¥–æ–≤—Ü–∏
                    </h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <input type="text" name="grandparent1" value={formData.grandparent1} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 1"/>
                      <input type="text" name="grandparent2" value={formData.grandparent2} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 2"/>
                      <input type="text" name="grandparent3" value={formData.grandparent3} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 3"/>
                      <input type="text" name="grandparent4" value={formData.grandparent4} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" placeholder="–ë–∞–±–∞/–î—è–¥–æ 4"/>
                    </div>
                  </div>
                </div>

                <div className="flex justify-between items-center">
                  <button onClick={() => setStep(2)} className="text-gray-500 hover:text-gray-700 px-6 py-3 font-medium transition-colors">–ù–∞–∑–∞–¥</button>
                  <button onClick={generateNames} disabled={isGenerating} className="flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-indigo-200 transition-all transform hover:scale-105 disabled:opacity-70 disabled:scale-100">
                    {isGenerating ? '–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–µ...' : '–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ò–º–µ–Ω–∞'} <Sparkles className="w-5 h-5" />
                  </button>
                </div>
              </div>
            )}

            {/* –ó–∞—Ä–µ–∂–¥–∞–Ω–µ */}
            {isGenerating && (
              <div className="absolute inset-0 bg-white/90 backdrop-blur-sm z-20 flex flex-col items-center justify-center rounded-3xl">
                <Search className="w-12 h-12 text-indigo-500 animate-bounce mb-4" />
                <h3 className="text-2xl font-bold text-gray-800 mb-2 animate-pulse">–°–∫–∞–Ω–∏—Ä–∞–Ω–µ –Ω–∞ –±–∞–∑–∏—Ç–µ...</h3>
                <p className="text-gray-500">–§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –Ω–∞–¥ {NAMES_DB.length.toLocaleString('bg-BG')} –∏–º–µ–Ω–∞ –æ—Ç —Ü—è–ª —Å–≤—è—Ç</p>
                <div className="w-48 h-2 bg-gray-200 rounded-full mt-6 overflow-hidden">
                  <div className="h-full bg-indigo-500 rounded-full animate-[progress_3.5s_ease-in-out]"></div>
                </div>
              </div>
            )}

            {/* –°—Ç—ä–ø–∫–∞ 4: –†–µ–∑—É–ª—Ç–∞—Ç–∏ */}
            {step === 4 && !isGenerating && (
              <div className="animate-in fade-in zoom-in-95 duration-500">
                <div className="text-center mb-10">
                  <div className="inline-block px-4 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-bold mb-4">
                    –û—Ç–∫—Ä–∏—Ç–∏ –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–∏ —Å—ä–≤–ø–∞–¥–µ–Ω–∏—è!
                  </div>
                  <h2 className="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-4">–ï—Ç–æ –Ω–∞—à–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
                  <p className="text-gray-600 max-w-lg mx-auto">
                    –†–∞–∑–≥–ª–µ–¥–∞–π—Ç–µ –Ω–∞–π-–ø–æ–¥—Ö–æ–¥—è—â–∏—Ç–µ –∏–º–µ–Ω–∞, –ø–æ–¥–±—Ä–∞–Ω–∏ –æ—Ç –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—Ç–∞ –Ω–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏.
                  </p>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
                  {generatedNames.map((nameData, index) => {
                    const isFav = favorites.some(f => f.fullName === nameData.fullName);
                    return (
                    <div key={index} className={`relative p-6 rounded-3xl border-2 shadow-sm transition-all hover:shadow-md ${nameData.gender === 'm' ? 'border-blue-100 bg-gradient-to-br from-white to-blue-50/50' : 'border-pink-100 bg-gradient-to-br from-white to-pink-50/50'}`}>
                      {index === 0 && (
                         <div className="absolute -top-3 -right-3 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full flex items-center shadow-sm z-10">
                           <Sparkles className="w-3 h-3 mr-1" /> –¢–æ–ø –∏–∑–±–æ—Ä
                         </div>
                      )}

                      <button 
                        onClick={() => toggleFavorite(nameData)}
                        className={`absolute top-4 right-4 p-2 rounded-full transition-colors z-10 ${isFav ? 'bg-pink-100 text-pink-500' : 'bg-white/50 text-gray-400 hover:bg-white hover:text-pink-400'}`}
                        title={isFav ? "–ü—Ä–µ–º–∞—Ö–Ω–∏ –æ—Ç –ª—é–±–∏–º–∏" : "–î–æ–±–∞–≤–∏ –≤ –ª—é–±–∏–º–∏"}
                      >
                        <Heart className="w-5 h-5" fill={isFav ? "currentColor" : "none"} />
                      </button>
                      
                      <div className="mb-4 pb-4 border-b border-gray-100/80 pr-10">
                         <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">–ü—ä–ª–Ω–æ –∏–º–µ</p>
                         <h3 className={`text-2xl sm:text-3xl font-bold ${nameData.gender === 'm' ? 'text-blue-900' : 'text-pink-900'}`}>
                           {nameData.fullName}
                         </h3>
                      </div>

                      <p className="text-sm font-medium text-gray-600 mb-4">
                        –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞: <span className="text-gray-900">{nameData.meaning}</span>
                      </p>
                      
                      <div className="space-y-2">
                        <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider">–ó–∞—â–æ —Ç–æ–∑–∏ –∏–∑–±–æ—Ä?</p>
                        <ul className="space-y-1">
                          {nameData.reasons.map((reason, i) => (
                            <li key={i} className="text-sm text-gray-700 flex items-start gap-2 leading-tight">
                              <span className={`${nameData.gender === 'm' ? 'text-blue-400' : 'text-pink-400'} mt-0.5`}>‚Ä¢</span> {reason}
                            </li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  )})}
                </div>

                <div className="flex flex-col sm:flex-row justify-center gap-4">
                  <button onClick={generateNames} className="flex items-center justify-center gap-2 bg-white border-2 border-indigo-100 hover:border-indigo-300 text-indigo-700 px-6 py-3 rounded-full font-medium transition-colors">
                    <RefreshCw className="w-5 h-5" /> –î—Ä—É–≥–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
                  </button>
                  <button onClick={resetForm} className="flex items-center justify-center gap-2 bg-gray-900 hover:bg-gray-800 text-white px-6 py-3 rounded-full font-medium transition-colors">
                    –ó–∞–ø–æ—á–Ω–∏ –æ—Ç–Ω–∞—á–∞–ª–æ
                  </button>
                </div>
              </div>
            )}

          </div>
        </div>

        {/* –ú–æ–¥–∞–ª –∑–∞ –õ—é–±–∏–º–∏ –∏–º–µ–Ω–∞ */}
        {showFavorites && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in">
            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden">
              <div className="p-6 border-b flex items-center justify-between bg-pink-50">
                <div className="flex items-center gap-2 text-pink-700">
                  <Heart className="w-6 h-6" fill="currentColor" />
                  <h2 className="text-2xl font-bold">–õ—é–±–∏–º–∏ –∏–º–µ–Ω–∞</h2>
                </div>
                <button onClick={() => setShowFavorites(false)} className="p-2 text-gray-500 hover:bg-white rounded-full transition-colors">
                  <X className="w-6 h-6" />
                </button>
              </div>
              
              <div className="p-6 overflow-y-auto flex-1">
                {favorites.length === 0 ? (
                  <div className="text-center py-12 text-gray-400">
                    <Heart className="w-12 h-12 mx-auto mb-4 opacity-20" />
                    <p>–í—Å–µ –æ—â–µ –Ω—è–º–∞—Ç–µ –∑–∞–ø–∞–∑–µ–Ω–∏ –ª—é–±–∏–º–∏ –∏–º–µ–Ω–∞.</p>
                    <button onClick={() => setShowFavorites(false)} className="mt-4 text-pink-600 font-medium hover:underline">
                      –í—ä—Ä–Ω–µ—Ç–µ —Å–µ –∏ –∏–∑–±–µ—Ä–µ—Ç–µ
                    </button>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {favorites.map((fav, i) => (
                      <div key={i} className="p-4 rounded-2xl border border-gray-100 bg-gray-50 relative group">
                        <button 
                          onClick={() => toggleFavorite(fav)}
                          className="absolute top-3 right-3 p-1.5 text-pink-500 opacity-0 group-hover:opacity-100 transition-opacity bg-white rounded-full shadow-sm"
                          title="–ü—Ä–µ–º–∞—Ö–Ω–∏"
                        >
                          <Heart className="w-4 h-4" fill="currentColor" />
                        </button>
                        <h4 className={`text-lg font-bold mb-1 ${fav.gender === 'm' ? 'text-blue-800' : 'text-pink-800'} pr-6`}>
                          {fav.fullName}
                        </h4>
                        <p className="text-xs text-gray-500 line-clamp-2">{fav.meaning}</p>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

      </main>

      <style dangerouslySetInnerHTML={{__html: `
        @keyframes progress {
          0% { width: 0%; }
          50% { width: 60%; }
          80% { width: 85%; }
          100% { width: 100%; }
        }
      `}} />
    </div>
  );
}
